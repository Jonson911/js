<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fred å¥åº·è¥å…»è®¡åˆ’ (V5.9 å¯¹é½ä¿®å¤ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 h-screen w-screen overflow-hidden flex justify-center items-center">

    <div id="root" class="w-full h-full max-w-md bg-white shadow-2xl overflow-hidden relative sm:rounded-xl sm:h-[90vh] sm:border sm:border-slate-200">
        <div class="flex h-full items-center justify-center text-slate-400 text-sm animate-pulse">
            æ­£åœ¨è¿æ¥ Fred çš„äº‘ç«¯æ•°æ®åº“...
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Activity, Utensils, Scale, Calendar, Trophy, TrendingDown, 
          Dumbbell, Droplets, BrainCircuit, ChevronRight, AlertTriangle, 
          Settings, Send, Loader2, Save, ChevronLeft, History, 
          CheckCircle2, XCircle, ArrowLeftRight, Sparkles, Flame, Apple, LogOut, Cloud, ChefHat, RefreshCw, Coffee, AlertOctagon, Wifi, WifiOff
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot } from "firebase/firestore";

        // =================================================================
        // ğŸ”‘ Fred çš„ä¸“å± Firebase å¯†é’¥
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBXbO4WzrrHTIIZ7BH6ChSsYrGepg-ymfQ",
            authDomain: "fred-fitness.firebaseapp.com",
            projectId: "fred-fitness",
            storageBucket: "fred-fitness.firebasestorage.app",
            messagingSenderId: "740270431308",
            appId: "1:740270431308:web:245155b5d8de8addaca8e9",
            measurementId: "G-QPYZJ2WKWN"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±è´¥", e);
        }

        const DEFAULT_DEEPSEEK_KEY = "sk-72fba3190e5c4147bdd1b27fcab574dc";
        
        // --- æ ¸å¿ƒæ•°æ®é…ç½® ---
        const BASE_PLAN = {
          1: { title: "èƒ¸éƒ¨ & ä¸‰å¤´è‚Œ (æ¨åŠ›)", type: "Strength", warmup: "10åˆ†é’Ÿ æ¤­åœ†æœº/å¿«èµ°", exercises: [
            { name: "åŠ¨æ€ä¼¸å±•", sets: "5åˆ†é’Ÿ", note: "è‚©è¢–é¢„çƒ­", alternatives: [{name: "å¼¹åŠ›å¸¦ç»•è‚©+å¼€åˆè·³", sets: "5åˆ†é’Ÿ", note: "å±…å®¶é¢„çƒ­"}] },
            { name: "å¹³æ¿æ é“ƒå§æ¨", sets: "4ç»„ x 10æ¬¡", note: "æ ¸å¿ƒåŠ¨ä½œ", alternatives: [{name: "å¤§é‡é‡å“‘é“ƒå§æ¨", sets: "4ç»„ x 10æ¬¡", note: "æ›´æ·±åˆºæ¿€"}, {name: "è´Ÿé‡/å¼¹åŠ›å¸¦ä¿¯å§æ’‘", sets: "4ç»„ x åŠ›ç«­", note: "å±…å®¶é«˜å¼ºåº¦"}] },
            { name: "ä¸Šæ–œå“‘é“ƒå§æ¨", sets: "4ç»„ x 12æ¬¡", note: "ä¸Šèƒ¸é¥±æ»¡åº¦", alternatives: [{name: "ä¸‹æ–œä¿¯å§æ’‘(è„šå«é«˜)", sets: "4ç»„ x 15æ¬¡", note: "å±…å®¶ä¸Šèƒ¸"}, {name: "å™¨æ¢°ä¸Šæ–œæ¨èƒ¸", sets: "4ç»„ x 12æ¬¡", note: "å›ºå®šè½¨è¿¹"}] },
            { name: "ç»³ç´¢ä¸‹å‹", sets: "4ç»„ x 15æ¬¡", note: "ä¸‰å¤´è‚Œé•¿å¤´", alternatives: [{name: "å“‘é“ƒé¢ˆåè‡‚å±ˆä¼¸", sets: "4ç»„ x 15æ¬¡", note: "å“‘é“ƒæ›¿ä»£"}, {name: "çª„è·ä¿¯å§æ’‘/å‡³ä¸Šåå±ˆä¼¸", sets: "4ç»„ x åŠ›ç«­", note: "å¾’æ‰‹æ›¿ä»£"}] },
            { name: "æ‚¬å‚ä¸¾è…¿", sets: "4ç»„ x åŠ›ç«­", note: "ä¸‹è…¹æ ¸å¿ƒ", alternatives: [{name: "ä»°å§æŠ¬è…¿", sets: "4ç»„ x 20æ¬¡", note: "å¹³åœ°æ›¿ä»£"}, {name: "åå‘å·è…¹", sets: "4ç»„ x 20æ¬¡", note: "æŠ¤è…°æ›¿ä»£"}] }
          ]},
          2: { title: "èƒŒéƒ¨ & äºŒå¤´è‚Œ (æ‹‰åŠ›)", type: "Strength", warmup: "10åˆ†é’Ÿ åˆ’èˆ¹æœº", exercises: [
            { name: "è‚©éƒ¨æ¿€æ´»", sets: "5åˆ†é’Ÿ", note: "å¼¹åŠ›å¸¦", alternatives: [{name: "å¾’æ‰‹YTWLä¼¸å±•", sets: "5åˆ†é’Ÿ", note: "æ— å™¨æ¢°æ¿€æ´»"}] },
            { name: "é«˜ä½ä¸‹æ‹‰", sets: "4ç»„ x 12æ¬¡", note: "èƒŒé˜”è‚Œå®½åº¦", alternatives: [{name: "å¼•ä½“å‘ä¸Š (åŠ©åŠ›å¸¦)", sets: "4ç»„ x 8æ¬¡", note: "é»„é‡‘åŠ¨ä½œ"}, {name: "å¼¹åŠ›å¸¦é«˜ä½ä¸‹æ‹‰ (æŒ‚é—¨ä¸Š)", sets: "4ç»„ x 20æ¬¡", note: "å±…å®¶æ›¿ä»£"}] },
            { name: "åå§¿åˆ’èˆ¹", sets: "4ç»„ x 12æ¬¡", note: "èƒŒéƒ¨åšåº¦", alternatives: [{name: "å•è‡‚å“‘é“ƒåˆ’èˆ¹", sets: "4ç»„ x 12æ¬¡", note: "æ ¸å¿ƒæŠ—æ—‹"}, {name: "æ¾³å¼å¼•ä½“ (æ¡Œåº•)", sets: "4ç»„ x åŠ›ç«­", note: "å±…å®¶é»‘ç§‘æŠ€"}] },
            { name: "æ é“ƒå¼¯ä¸¾", sets: "4ç»„ x 12æ¬¡", note: "äºŒå¤´è‚Œæ•´ä½“", alternatives: [{name: "å“‘é“ƒäº¤æ›¿å¼¯ä¸¾", sets: "4ç»„ x 12æ¬¡", note: "æ›´å­¤ç«‹"}, {name: "é›†ä¸­å¼¯ä¸¾", sets: "4ç»„ x 15æ¬¡", note: "è‚Œå³°åˆ»ç”»"}] },
            { name: "å¹³æ¿æ”¯æ’‘", sets: "4ç»„ x 60ç§’", note: "æ ¸å¿ƒæŠ—ä¼¸å±•", alternatives: [{name: "æ­»è™«å¼", sets: "4ç»„ x 20æ¬¡", note: "æŠ¤è…°ä¸”é«˜æ•ˆ"}, {name: "RKCå¹³æ¿æ”¯æ’‘ (å…¨åŠ›æ”¶ç¼©)", sets: "4ç»„ x 30ç§’", note: "é«˜å¼ºåº¦ç‰ˆ"}] }
          ]},
          3: { title: "è…¿éƒ¨ & è‚©éƒ¨ (å¼ºä»£è°¢)", type: "HighIntensity", warmup: "10åˆ†é’Ÿ å•è½¦", exercises: [
            { name: "é«‹å…³èŠ‚çµæ´»æ€§", sets: "5åˆ†é’Ÿ", note: "å¿…åš", alternatives: [{name: "ä¸–ç•Œæœ€ä¼Ÿå¤§æ‹‰ä¼¸", sets: "5åˆ†é’Ÿ", note: "å…¨èº«åŠ¨æ€"}] },
            { name: "æ·±è¹²/è…¿ä¸¾", sets: "5ç»„ x 10æ¬¡", note: "ä¿ƒç¾ç‹ç‰Œ", alternatives: [{name: "é«˜è„šæ¯æ·±è¹²", sets: "5ç»„ x 15æ¬¡", note: "å“‘é“ƒæ›¿ä»£"}, {name: "ä¿åŠ åˆ©äºšåˆ†è…¿è¹²", sets: "4ç»„ x 12æ¬¡", note: "è™è‡€è…¿ç¥æŠ€(æ— éœ€å¤§é‡é‡)"}] },
            { name: "å“‘é“ƒæ¨ä¸¾", sets: "4ç»„ x 12æ¬¡", note: "ä¸‰è§’è‚Œå‰æŸ", alternatives: [{name: "å€’ç«‹æ’‘/æŠ˜åˆ€ä¿¯å§æ’‘", sets: "4ç»„ x 10æ¬¡", note: "è‡ªé‡é«˜éš¾åº¦"}, {name: "é˜¿è¯ºå¾·æ¨ä¸¾", sets: "4ç»„ x 12æ¬¡", note: "å…¨é¢åˆºæ¿€"}] },
            { name: "ä¾§å¹³ä¸¾", sets: "5ç»„ x 15æ¬¡", note: "ä¸­æŸ(å®½è‚©)", alternatives: [{name: "å¼¹åŠ›å¸¦ä¾§å¹³ä¸¾", sets: "5ç»„ x 20æ¬¡", note: "æŒç»­å¼ åŠ›"}, {name: "ç›´ç«‹åˆ’èˆ¹", sets: "4ç»„ x 12æ¬¡", note: "å¤åˆåŠ¨ä½œ"}] },
            { name: "è…¿å±ˆä¼¸", sets: "3ç»„ x 15æ¬¡", note: "è‚¡å››çº¿æ¡", alternatives: [{name: "åæ’¤ç®­æ­¥è¹²", sets: "3ç»„ x 20æ¬¡", note: "å¾’æ‰‹æ›¿ä»£"}, {name: "é å¢™é™è¹²", sets: "4ç»„ x 60ç§’", note: "è†ç›–åº·å¤"}] }
          ]},
          4: { title: "æœ‰æ°§ç‡ƒè„‚ & è…¹è‚Œ", type: "Cardio", warmup: "5åˆ†é’Ÿ æ…¢è·‘", exercises: [
            { name: "å·è…¹", sets: "4ç»„ x 20æ¬¡", note: "ä¸Šè…¹", alternatives: [{name: "æ‘¸è†å·è…¹", sets: "4ç»„ x 20æ¬¡", note: "åŸºç¡€"}, {name: "è´Ÿé‡å·è…¹", sets: "4ç»„ x 12æ¬¡", note: "è¿›é˜¶"}] },
            { name: "ä¿„ç½—æ–¯è½¬ä½“", sets: "4ç»„ x 20æ¬¡", note: "ä¾§è…¹", alternatives: [{name: "ä¾§æ”¯æ’‘é™æ€ä¿æŒ", sets: "4ç»„ x 45ç§’", note: "é™æ€æ ¸å¿ƒ"}, {name: "é›¨åˆ·å™¨", sets: "4ç»„ x 12æ¬¡", note: "é«˜éš¾åº¦ä¾§è…¹"}] },
            { name: "åå‘å·è…¹", sets: "4ç»„ x 15æ¬¡", note: "ä¸‹è…¹", alternatives: [{name: "ç™»å±±è·‘", sets: "4ç»„ x 30ç§’", note: "å¿ƒè‚ºç»“åˆ"}, {name: "å‰ªåˆ€è…¿", sets: "4ç»„ x 30ç§’", note: "æŒç»­å¼ åŠ›"}] },
            { name: "çœŸç©ºè…¹", sets: "5ç»„ x 30ç§’", note: "è…¹æ¨ªè‚Œ(ç»†è…°)", alternatives: [{name: "å¹³æ¿æ”¯æ’‘", sets: "4ç»„ x 60ç§’", note: "æ›¿ä»£"}, {name: "è…¹å¼å‘¼å¸è®­ç»ƒ", sets: "5åˆ†é’Ÿ", note: "éšæ—¶å¯åš"}] }
          ]},
          5: { title: "æ·±åº¦æ¢å¤ (REST)", type: "Rest", warmup: "æ— ", exercises: [
            { name: "æ³¡æ²«è½´æ”¾æ¾", sets: "20åˆ†é’Ÿ", note: "å…¨èº«ç­‹è†œ", alternatives: [{name: "ç‘œä¼½æ‹‰ä¼¸ (Bç«™è·Ÿç»ƒ)", sets: "20åˆ†é’Ÿ", note: "æŸ”éŸ§æ€§"}, {name: "ç­‹è†œæªå®šç‚¹æ”¾æ¾", sets: "15åˆ†é’Ÿ", note: "å™¨æ¢°è¾…åŠ©"}] },
            { name: "æ¸©æ°´æ¾¡/æ¡‘æ‹¿", sets: "15åˆ†é’Ÿ", note: "è¡€æ¶²å¾ªç¯", alternatives: [{name: "å†¥æƒ³/å‘¼å¸æ³•", sets: "10åˆ†é’Ÿ", note: "é™ä½çš®è´¨é†‡"}, {name: "æ—©ç¡1å°æ—¶", sets: "8å°æ—¶+", note: "ç”Ÿé•¿æ¿€ç´ åˆ†æ³Œ"}] }
          ]},
          6: { title: "HIIT & å…¨èº«å¾ªç¯", type: "HIIT", warmup: "5åˆ†é’Ÿ åŠ¨æ€", exercises: [
            { name: "æ³¢æ¯”è·³", sets: "10ä¸ª x 5ç»„", note: "å¿ƒè‚ºè½°ç‚¸", alternatives: [{name: "ç®€æ˜“æ³¢æ¯”(ä¸ä¿¯å§æ’‘)", sets: "10ä¸ª x 5ç»„", note: "é™é˜¶"}, {name: "æ»‘é›ªè·³", sets: "30ç§’ x 5ç»„", note: "ä¾§å‘çˆ†å‘åŠ›"}] },
            { name: "å£¶é“ƒæ‘‡æ‘†", sets: "20ä¸ª x 4ç»„", note: "åé“¾çˆ†å‘åŠ›", alternatives: [{name: "è‡€æ¡¥", sets: "20ä¸ª x 4ç»„", note: "å¾’æ‰‹æ›¿ä»£"}, {name: "å“‘é“ƒç¡¬æ‹‰", sets: "15ä¸ª x 4ç»„", note: "åŸºç¡€åŠ¨ä½œ"}] },
            { name: "æˆ˜ç»³", sets: "30ç§’ x 4ç»„", note: "ä¸Šè‚¢ä»£è°¢", alternatives: [{name: "å¿«é€Ÿå¼€åˆè·³", sets: "45ç§’ x 4ç»„", note: "å¾’æ‰‹æ›¿ä»£"}, {name: "æ‹³å‡»ç©ºå‡»", sets: "1åˆ†é’Ÿ x 4ç»„", note: "åè°ƒæ€§"}] },
            { name: "æ ¸å¿ƒä¸‰åˆä¸€", sets: "3ç»„", note: "è…¹è‚Œæ”¶å°¾", alternatives: [{name: "å·è…¹è¶…çº§ç»„", sets: "3ç»„", note: "æ›¿ä»£"}] }
          ]},
          0: { title: "æˆ·å¤–è€åŠ›", type: "ActiveRecovery", warmup: "åŠ¨æ€æ‹‰ä¼¸", exercises: [
            { name: "æˆ·å¤–éª‘è¡Œ/çˆ¬å±±", sets: "60åˆ†é’Ÿ+", note: "Zone 2å¿ƒç‡", alternatives: [{name: "å®¤å†…åŠ¨æ„Ÿå•è½¦", sets: "45åˆ†é’Ÿ", note: "é›¨å¤©æ›¿ä»£"}, {name: "è·‘æ­¥æœºçˆ¬å¡ (å¡åº¦10)", sets: "40åˆ†é’Ÿ", note: "å¼ºåŠ›ç‡ƒè„‚"}, {name: "çˆ¬æ¥¼æ¢¯", sets: "30åˆ†é’Ÿ", note: "é«˜å¼ºåº¦æ›¿ä»£"}] },
            { name: "å…¨èº«æ‹‰ä¼¸", sets: "20åˆ†é’Ÿ", note: "é™æ€", alternatives: [{name: "æ³¡æ²«è½´å…¨èº«", sets: "20åˆ†é’Ÿ", note: "æ›¿ä»£"}] }
          ]}
        };

        const MEAL_PLANS = {
            Strength: {
                breakfast: [
                    {main: "å…¨éº¦ä¸‰æ˜æ²» (2ç‰‡é¢åŒ…+2ç…è›‹+èŠå£«) + ç‰›å¥¶250ml", alt: "çº¯ç‡•éº¦80g + è›‹ç™½ç²‰1å‹º + åšæœä¸€å°æŠŠ + é¸¡è›‹1ä¸ª", note: "çº¦550å¤§å¡, 35gè›‹ç™½"},
                    {main: "ç‰›è‚‰æ±‰å ¡ (è‡ªåˆ¶/å°‘é…±) + é»‘å’–å•¡", alt: "å…¨éº¦é¦’å¤´2ä¸ª + æ— ç³–è±†æµ† + å¤ç‰›è‚‰100g", note: "çº¦600å¤§å¡, 40gè›‹ç™½"}
                ],
                lunch: [
                    {main: "ç…é¸¡èƒ¸è‚‰200g + ç±³é¥­200g + ç‚’æ—¶è”¬", alt: "ç˜¦ç‰›è‚‰200g + åœŸè±†/çº¢è–¯250g + å‡‰æ‹Œèœ", note: "çº¦750å¤§å¡, 50gè›‹ç™½"},
                    {main: "å¤§ä»½é²œè™¾(20åª) + èéº¦é¢ + è·åŒ…è›‹", alt: "å»çš®é¸¡è…¿2ä¸ª + ç‰ç±³1æ ¹ + è¥¿å…°èŠ±", note: "çº¦700å¤§å¡, 45gè›‹ç™½"}
                ],
                dinner: [
                    {main: "æ¸…è’¸é±¼/æµ·é²œ200g + æ‚ç²®ç²¥ + è”¬èœ", alt: "ç˜¦è‚‰ä¸¸å­æ±¤ (200gè‚‰) + å°‘é‡ç²‰ä¸ + å†¬ç“œ", note: "çº¦500å¤§å¡, 40gè›‹ç™½"},
                    {main: "é¸¡è‚‰æ²™æ‹‰ (200gé¸¡è‚‰) + æ²¹é†‹æ±", alt: "ç…è±†è… + ç˜¦è‚‰ç‰‡150g + èŒè‡æ±¤", note: "çº¦450å¤§å¡, 35gè›‹ç™½"}
                ],
                snacks: [ 
                    {main: "è®­ç»ƒåï¼šè›‹ç™½ç²‰1å‹º + é¦™è•‰1æ ¹", alt: "åŠ é¤ï¼šå¸Œè…Šé…¸å¥¶1ç›’ + è“è“", note: "çº¦300å¤§å¡, 25gè›‹ç™½"}
                ]
            },
            HighIntensity: {
                breakfast: [
                    {main: "æ°´ç…®è›‹3ä¸ª(å»1é»„) + ç‰ç±³1æ ¹ + ç‰›å¥¶", alt: "å…¨éº¦é¢åŒ…2ç‰‡ + èŠ±ç”Ÿé…± + è›‹ç™½ç²‰", note: "çº¦500å¤§å¡, 30gè›‹ç™½"},
                ],
                lunch: [
                    {main: "ç‰›è‚‰ç›–é¥­ (å°‘æ²¹) + é¢å¤–åŠ è›‹", alt: "çƒ¤é±¼é¥­ (200gé±¼) + å°‘é‡ç±³é¥­ + è”¬èœ", note: "çº¦700å¤§å¡, 45gè›‹ç™½"},
                ],
                dinner: [
                    {main: "ä¸‰æ–‡é±¼/é‡‘æªé±¼åˆºèº« + æ²™æ‹‰", alt: "è™¾ä»æ»‘è›‹ (200gè™¾) + æ‚ç²®é¥­åŠç¢—", note: "çº¦500å¤§å¡, 40gè›‹ç™½"},
                ],
                snacks: [
                    {main: "ä¸‹åˆåŠ é¤ï¼šå…¨éº¦é¢åŒ…1ç‰‡ + ç‰›è‚‰å¹²", alt: "ç»ƒåï¼šè›‹ç™½ç²‰1å‹º + è¿åŠ¨é¥®æ–™", note: "çº¦300å¤§å¡, 25gè›‹ç™½"}
                ]
            },
            Rest: {
                breakfast: [
                    {main: "é»‘å’–å•¡ + æ°´ç…®è›‹2ä¸ª + è›‹ç™½1ä¸ª (æ— ç¢³æ°´)", alt: "æ— ç³–è±†æµ† + é¸¡èƒ¸è‚‰è‚ 2æ ¹", note: "çº¦350å¤§å¡, 25gè›‹ç™½"},
                ],
                lunch: [
                    {main: "å¤§ä»½ç‰›æ’æ²™æ‹‰ (200gç‰›è‚‰, æ— ä¸»é£Ÿ)", alt: "ç™½ç¼è™¾300g + çƒ«é’èœ", note: "çº¦600å¤§å¡, 50gè›‹ç™½"},
                ],
                dinner: [
                    {main: "é»„ç“œé¸¡è›‹è™¾ä»æ±¤ (æ— ä¸»é£Ÿ)", alt: "ç•ªèŒ„èœèŠ±ç‚’è‚‰ç‰‡ (ä»¿ç±³é¥­å£æ„Ÿ)", note: "çº¦400å¤§å¡, 35gè›‹ç™½"},
                ],
                snacks: [
                    {main: "é¥¥é¥¿æ—¶ï¼šå°æŠŠåšæœ / è›‹ç™½æ£’", alt: "ç¡å‰ï¼šé…ªè›‹ç™½/ç‰›å¥¶", note: "çº¦200å¤§å¡, 15gè›‹ç™½"}
                ]
            }
        };

        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- Auth Component ---
        const LoginScreen = ({ onLogin }) => {
            const [error, setError] = useState(null);
            
            const handleGoogleLogin = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    setError("ç™»å½•å¤±è´¥: " + err.message);
                }
            };

            return (
                <div className="h-full flex flex-col items-center justify-center p-6 bg-slate-900 text-white animate-fade-in">
                    <Activity className="w-20 h-20 text-indigo-500 mb-6" />
                    <h1 className="text-3xl font-black mb-2">FRED<span className="text-indigo-500">.FIT</span></h1>
                    <p className="text-slate-400 mb-8 text-center text-sm">äº‘ç«¯åŒæ­¥ Â· å¤šç«¯æ‰“å¡ Â· æ™ºèƒ½æ•™ç»ƒ</p>
                    
                    <button 
                        onClick={handleGoogleLogin}
                        className="w-full max-w-xs bg-white text-slate-900 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-100 transition-colors"
                    >
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" />
                        ä½¿ç”¨ Google è´¦å·ç™»å½•
                    </button>
                    
                    {error && <div className="mt-4 text-red-400 text-xs bg-red-900/30 p-2 rounded">{error}</div>}
                    <div className="mt-12 text-xs text-slate-600">V5.9 Aligned Trends</div>
                </div>
            );
        };

        const SettingsTab = ({ apiKey, setApiKey, userProfile, saveProfile, setSetupMode, handleReset }) => (
          <div className="p-6 space-y-6 animate-fade-in bg-white h-full overflow-y-auto">
            <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Settings className="w-6 h-6" /> è´¦æˆ·ä¸è®¾ç½®</h2>
            <div className="space-y-6">
              <div className="bg-slate-50 p-4 rounded-xl space-y-3">
                  <h3 className="font-bold text-sm text-slate-500">API é…ç½®</h3>
                  <div><label className="text-xs font-bold text-slate-400 block mb-1">DeepSeek Key</label><input type="password" value={apiKey} onChange={e => { setApiKey(e.target.value); localStorage.setItem('fred_deepseek_key', e.target.value); }} className="w-full bg-white border border-slate-200 rounded px-3 py-2 text-sm outline-none focus:border-indigo-500" placeholder="sk-..." /></div>
              </div>
              
              <div className="bg-slate-50 p-4 rounded-xl space-y-3">
                  <h3 className="font-bold text-sm text-slate-500">å½“å‰ç›®æ ‡</h3>
                  <div className="grid grid-cols-2 gap-3">
                      <div><label className="text-xs font-bold text-slate-400 block mb-1">ç›®æ ‡ä½“é‡ (kg)</label><input type="number" value={userProfile.goalWeight} onChange={e => { const p = {...userProfile, goalWeight: parseFloat(e.target.value)}; saveProfile(p); }} className="w-full bg-white border border-slate-200 rounded px-3 py-2 text-sm font-bold text-slate-700" /></div>
                      <div><label className="text-xs font-bold text-slate-400 block mb-1">è›‹ç™½ç›®æ ‡ (g)</label><input type="number" value={userProfile.targetProtein} onChange={e => { const p = {...userProfile, targetProtein: parseFloat(e.target.value)}; saveProfile(p); }} className="w-full bg-white border border-slate-200 rounded px-3 py-2 text-sm font-bold text-slate-700" /></div>
                  </div>
              </div>

              <div className="pt-8 border-t border-slate-100">
                  <button onClick={handleReset} className="w-full py-4 bg-red-50 text-red-600 rounded-xl text-sm font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-2 border border-red-100">
                      <RefreshCw className="w-4 h-4"/> é‡ç½®è®¡åˆ’å¹¶é‡æ–°å¼€å§‹
                  </button>
                  <p className="text-xs text-slate-400 mt-2 text-center">æ³¨æ„ï¼šè¿™å°†æ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®ï¼Œè®©ä½ é‡æ–°è®¾å®šåˆå§‹ä½“é‡ã€‚</p>
              </div>
            </div>
          </div>
        );

        const HistoryTab = ({ userProfile, logs }) => {
          const historyData = useMemo(() => {
            const days = [];
            const today = new Date();
            // æ ¸å¿ƒä¿®æ”¹ï¼šä¸Šä¸‹éƒ½ä½¿ç”¨14å¤©æ•°æ®ï¼Œç¡®ä¿Xè½´å¯¹é½
            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const dateStr = formatDate(d);
                let log = logs[dateStr];
                if (!log) { 
                    log = { isVirtual: true, weight: null, calories: 0, protein: 0, workoutCompleted: false }; 
                }
                days.push({ date: dateStr, ...log, dayObj: d });
            }
            return days;
          }, [logs]);

          const currentWeight = historyData.slice().reverse().find(d => d.weight > 0)?.weight || userProfile.startWeight;
          const progress = (userProfile.startWeight - currentWeight).toFixed(1);
          
          let plotData = [...historyData];
          if (plotData.every(d => !d.weight)) {
              plotData[0].weight = userProfile.startWeight; // Fallback
          }

          const validWeights = plotData.filter(d => d.weight > 0).map(d => d.weight);
          const minW = validWeights.length ? Math.min(...validWeights, userProfile.goalWeight) - 1 : 70;
          const maxW = validWeights.length ? Math.max(...validWeights, userProfile.startWeight) + 1 : 90;
          const range = maxW - minW || 1;
          const goalY = 100 - ((userProfile.goalWeight - minW) / range) * 100;

          const points = plotData.map((day, index) => {
              if (!day.weight || day.weight <= 0) return null;
              return { index, weight: day.weight };
          }).filter(p => p !== null);

          // SVG åæ ‡ç”Ÿæˆ
          const svgPoints = points.map(p => { 
             const x = (p.index / 13) * 100; 
             const y = 100 - ((p.weight - minW) / range) * 100; 
             return {x, y, val: p.weight}; 
          });

          const linePath = svgPoints.map(p => `${p.x},${p.y}`).join(" ");
          let areaPath = "";
          if (svgPoints.length > 1) {
              const first = svgPoints[0];
              const last = svgPoints[svgPoints.length - 1];
              areaPath = `${linePath} L${last.x},100 L${first.x},100 Z`;
          }

          const calculateScore = (day) => {
              if (day.isVirtual) return 0;
              let score = 0;
              if (day.workoutCompleted) score += 40;
              const proTarget = userProfile.targetProtein || 160;
              if (day.protein >= proTarget * 0.8) score += 30; else if (day.protein > 0) score += (day.protein / proTarget) * 30;
              const calTarget = userProfile.targetCaloriesTrain || 2300;
              if (day.calories > 0 && day.calories <= calTarget + 400) score += 30; else if (day.calories > 0) score += 10;
              return Math.min(100, Math.round(score));
          };

          return (
            <div className="space-y-6 animate-fade-in pb-24 p-4">
              <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-4 opacity-5"><TrendingDown className="w-24 h-24" /></div>
                <div className="relative z-10">
                    <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Trophy className="w-5 h-5 text-yellow-500" /> å‡è„‚è¿›åº¦</h2>
                    <div className="flex items-end gap-2 mb-2">
                        <span className="text-4xl font-black text-slate-800">{currentWeight}</span><span className="text-sm text-slate-500 mb-1">kg</span>
                        <span className="ml-auto text-sm font-bold text-green-600 bg-green-50 px-2 py-1 rounded-lg">å·²å‡ {Math.abs(progress)} kg</span>
                    </div>
                    <div className="w-full bg-slate-100 h-3 rounded-full overflow-hidden"><div className="bg-gradient-to-r from-indigo-500 to-purple-500 h-full transition-all duration-1000" style={{ width: `${Math.min(100, Math.max(0, (progress / (userProfile.startWeight - userProfile.goalWeight)) * 100))}%` }}></div></div>
                </div>
              </div>

              <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Activity className="w-5 h-5 text-indigo-500" /> ä½“é‡è¶‹åŠ¿ (è¿‘14å¤©)</h2>
                <div className="h-44 w-full relative px-1 select-none">
                    <div className="absolute w-full border-t border-dashed border-green-300 left-0 transition-all duration-500" style={{top: `${Math.min(100, Math.max(0, goalY))}%`}}></div>
                    <div className="absolute right-0 text-[10px] text-green-600 -mt-4 bg-white px-1 transition-all duration-500 font-bold" style={{top: `${Math.min(100, Math.max(0, goalY))}%`}}>Goal {userProfile.goalWeight}</div>
                    
                    {/* ç½‘æ ¼å‚è€ƒçº¿ */}
                    <div className="absolute inset-0 flex justify-between pointer-events-none">
                        {[...Array(14)].map((_, i) => <div key={i} className="w-px h-full bg-slate-50"></div>)}
                    </div>

                    <svg className="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor="#6366f1" stopOpacity="0.2"/>
                                <stop offset="100%" stopColor="#6366f1" stopOpacity="0"/>
                            </linearGradient>
                        </defs>
                        {svgPoints.length > 0 && <path d={areaPath} fill="url(#chartGradient)" vectorEffect="non-scaling-stroke" />}
                        {svgPoints.length > 0 && <polyline fill="none" stroke="#6366f1" strokeWidth="2" points={linePath} strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke" />}
                        
                        {svgPoints.map((p, i) => (
                             <g key={i}>
                                <circle cx={`${p.x}`} cy={`${p.y}`} r="1.5" className={`stroke-1 ${i === svgPoints.length - 1 ? 'fill-indigo-600 stroke-white' : 'fill-white stroke-indigo-500'}`} vectorEffect="non-scaling-stroke" />
                             </g>
                        ))}
                    </svg>
                </div>
              </div>

              <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Calendar className="w-5 h-5 text-orange-500" /> ç»¼åˆè¾¾æ ‡ç‡ (è¿‘14å¤©)</h2>
                {/* æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ä¸º 14 åˆ—ï¼Œä¸ä¸Šé¢ä½“é‡å›¾å®Œå…¨å¯¹é½ */}
                <div className="flex justify-between items-end gap-1 h-40">
                  {historyData.map((day, i) => {
                    const score = calculateScore(day);
                    let color = "bg-slate-200";
                    if (score >= 80) color = "bg-green-500"; else if (score >= 50) color = "bg-indigo-400"; else if (score > 0) color = "bg-orange-300";
                    const isToday = day.date === formatDate(new Date());
                    
                    // ä»…æ˜¾ç¤ºç‰¹å®šæ—¥æœŸçš„æ ‡ç­¾ä»¥é˜²æ‹¥æŒ¤ (æ¯éš”2å¤©æ˜¾ç¤ºï¼Œæˆ–é¦–å°¾æ˜¾ç¤º)
                    const showLabel = i === 0 || i === 6 || i === 13;

                    return (
                        <div key={i} className="flex-1 flex flex-col items-center justify-end gap-1 group relative h-full">
                            {/* åˆ†æ•°æç¤º */}
                            <div className={`text-[8px] font-bold mb-1 transition-all ${score > 0 ? 'text-slate-600' : 'text-transparent'}`}>{score}</div>
                            
                            <div className="w-full h-24 bg-slate-50 rounded-sm relative flex items-end overflow-hidden">
                                <div className={`w-full transition-all duration-700 ease-out ${color} ${isToday ? 'ring-1 ring-inset ring-indigo-300' : ''}`} style={{height: `${score}%`}}></div>
                            </div>
                            
                            {/* æ—¥æœŸæ ‡ç­¾ï¼šåªæ˜¾ç¤ºéƒ¨åˆ† */}
                            <div className={`text-[8px] font-mono scale-90 whitespace-nowrap ${showLabel ? 'opacity-100' : 'opacity-0'} ${isToday ? 'text-indigo-600 font-bold opacity-100' : 'text-slate-300'}`}>
                                {day.date.slice(8)}æ—¥
                            </div>
                        </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        };

        const LoggerTab = ({ 
          selectedDate, setSelectedDate, log, saveLog, userProfile, dayPlan, logs,
          foodInput, setFoodInput, handleFoodAnalysis, loading, generateDailySummary, isSyncing, syncError
        }) => {
          const isToday = formatDate(selectedDate) === formatDate(new Date());
          const getMealPlan = () => {
              let type = dayPlan.type; if (type !== 'Strength' && type !== 'HighIntensity') type = 'Rest'; 
              const plan = MEAL_PLANS[type] || MEAL_PLANS['Strength']; const idx = selectedDate.getDate() % 2; 
              return { breakfast: plan.breakfast[Math.min(idx, plan.breakfast.length-1)], lunch: plan.lunch[Math.min(idx, plan.lunch.length-1)], dinner: plan.dinner[Math.min(idx, plan.dinner.length-1)], snacks: plan.snacks ? plan.snacks[0] : {main: "æ— ", alt: "æ— ", note: ""} }
          };
          const dailyMeal = getMealPlan();
          const toggleExercise = (index) => {
            const currentSwaps = log.swaps || {}; const exercise = dayPlan.exercises[index];
            if (!exercise.alternatives || exercise.alternatives.length === 0) return;
            const currentAltIndex = currentSwaps[index];
            let nextAltIndex = (currentAltIndex === undefined) ? 0 : (currentAltIndex < exercise.alternatives.length - 1 ? currentAltIndex + 1 : undefined);
            const newSwaps = { ...currentSwaps };
            if (nextAltIndex === undefined) delete newSwaps[index]; else newSwaps[index] = nextAltIndex;
            saveLog(formatDate(selectedDate), { swaps: newSwaps, isVirtual: false });
          };

          return (
            <div className="space-y-4 animate-fade-in pb-24 p-4">
              <div className="flex items-center justify-between bg-white p-3 rounded-2xl shadow-sm sticky top-0 z-20 border border-slate-100 backdrop-blur-md bg-opacity-90">
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() - 1); setSelectedDate(d); }} className="p-2 bg-slate-50 rounded-full text-slate-600 hover:bg-slate-100"><ChevronLeft className="w-5 h-5" /></button>
                <div className="text-center"><div className="font-bold text-slate-800 flex items-center justify-center gap-2 text-lg">{isToday && <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>}{selectedDate.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}</div><div className="text-[10px] text-indigo-500 font-bold uppercase mt-0.5 tracking-wider">{dayPlan.title}</div></div>
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() + 1); setSelectedDate(d); }} className="p-2 bg-slate-50 rounded-full text-slate-600 hover:bg-slate-100"><ChevronRight className="w-5 h-5" /></button>
              </div>

              {syncError && <div className="bg-red-50 border border-red-200 p-3 rounded-xl flex gap-3 text-xs text-red-700 items-start animate-bounce"><WifiOff className="w-4 h-4 shrink-0 mt-0.5" /><span>äº‘ç«¯åŒæ­¥å¤±è´¥ (æƒé™ä¸è¶³)ã€‚è¯·å» Firebase æ§åˆ¶å° Rules è®¾ç½® "allow read, write: if request.auth != null;" ä¸´æ—¶æµ‹è¯•ã€‚æ•°æ®å·²ä¿å­˜åœ¨æœ¬åœ°ã€‚</span></div>}

              <div className={`bg-white p-5 rounded-3xl shadow-sm border-l-4 transition-all ${log.workoutCompleted ? 'border-green-500 shadow-green-100' : 'border-indigo-500'}`}>
                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-900 flex items-center gap-2"><Dumbbell className="w-5 h-5 text-indigo-500" /> ä»Šæ—¥è®­ç»ƒ</h3><button onClick={() => saveLog(formatDate(selectedDate), { workoutCompleted: !log.workoutCompleted, isVirtual: false })} className={`px-4 py-2 rounded-full text-xs font-bold flex items-center gap-1.5 transition-all ${log.workoutCompleted ? 'bg-green-500 text-white shadow-lg shadow-green-200 transform scale-105' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{log.workoutCompleted ? <CheckCircle2 className="w-3.5 h-3.5" /> : <div className="w-3.5 h-3.5 rounded-full border-2 border-slate-300"></div>}{log.workoutCompleted ? 'å·²å®Œæˆ' : 'æ‰“å¡'}</button></div>
                <div className="space-y-4">{dayPlan.exercises.map((ex, i) => { const swapIndex = log.swaps ? log.swaps[i] : undefined; const isSwapped = swapIndex !== undefined; const displayEx = isSwapped ? ex.alternatives[swapIndex] : ex; const hasAlts = ex.alternatives && ex.alternatives.length > 0; return (<div key={i} className="flex justify-between items-start border-b border-slate-50 pb-3 last:border-0 group"><div className="flex-1"><div className="flex items-center gap-2"><span className={`text-sm font-bold ${isSwapped ? 'text-indigo-600' : 'text-slate-700'}`}>{displayEx.name}</span>{isSwapped && <span className="text-[10px] bg-indigo-50 text-indigo-500 px-1.5 py-0.5 rounded-md font-medium">æ›¿ä»£</span>}</div><div className="text-xs text-slate-400 font-mono mt-1 flex gap-2"><span className="bg-slate-50 px-1.5 rounded">{displayEx.sets}</span><span>{displayEx.note}</span></div></div>{hasAlts && <button onClick={() => toggleExercise(i)} className="p-2 text-slate-200 hover:text-indigo-500 hover:bg-indigo-50 rounded-full transition-all"><ArrowLeftRight className="w-4 h-4" /></button>}</div>);})}</div>
              </div>

              <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-5 rounded-3xl shadow-sm border border-orange-100">
                  <div className="flex items-center gap-2 mb-3 font-bold text-orange-800"><ChefHat className="w-5 h-5"/> ä¸»å¨æ¨è ({dayPlan.type === 'Rest' ? 'ä½ç¢³æ¢å¤' : 'å¢è‚Œå……èƒ½'})</div>
                  <div className="space-y-3">
                      <div className="bg-white bg-opacity-60 p-3 rounded-xl"><div className="text-[10px] text-orange-400 font-bold uppercase mb-1">æ—©é¤ Breakfast</div><div className="text-sm font-medium text-slate-700">{dailyMeal.breakfast.main}</div><div className="text-[10px] text-slate-400 mt-1">{dailyMeal.breakfast.note}</div></div>
                      <div className="bg-white bg-opacity-60 p-3 rounded-xl"><div className="text-[10px] text-orange-400 font-bold uppercase mb-1">åˆé¤ Lunch</div><div className="text-sm font-medium text-slate-700">{dailyMeal.lunch.main}</div><div className="text-[10px] text-slate-400 mt-1">{dailyMeal.lunch.note}</div></div>
                      <div className="bg-white bg-opacity-60 p-3 rounded-xl"><div className="text-[10px] text-orange-400 font-bold uppercase mb-1">æ™šé¤ Dinner</div><div className="text-sm font-medium text-slate-700">{dailyMeal.dinner.main}</div><div className="text-[10px] text-slate-400 mt-1">{dailyMeal.dinner.note}</div></div>
                      <div className="bg-indigo-50 bg-opacity-80 p-3 rounded-xl border border-indigo-100"><div className="flex items-center gap-1 text-[10px] text-indigo-500 font-bold uppercase mb-1"><Coffee className="w-3 h-3"/> å…³é”®åŠ é¤ Snack</div><div className="text-sm font-bold text-indigo-900">{dailyMeal.snacks.main}</div><div className="text-[10px] text-indigo-400 mt-1">{dailyMeal.snacks.note}</div></div>
                  </div>
              </div>

              <div className="bg-white p-5 rounded-3xl shadow-sm">
                <div className="flex items-center gap-2 mb-4 font-bold text-slate-800"><Utensils className="w-5 h-5 text-indigo-500" /> é¥®é£Ÿä¸èº«ä½“æ•°æ®</div>
                <div className="bg-indigo-50 p-3 rounded-2xl mb-6 border border-indigo-100 relative"><textarea value={foodInput} onChange={e => setFoodInput(e.target.value)} placeholder="AI å¸®æˆ‘ç®—ï¼šåˆé¥­åƒäº†ä¸€ç¢—ç‰›è‚‰é¢..." className="w-full bg-white p-3 text-sm rounded-xl outline-none border border-transparent focus:border-indigo-300 h-20 resize-none mb-2 placeholder-indigo-200 text-indigo-900" /><button onClick={handleFoodAnalysis} disabled={loading} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-xl text-xs font-bold flex justify-center items-center gap-1.5 transition-colors shadow-lg shadow-indigo-200">{loading ? <Loader2 className="w-3.5 h-3.5 animate-spin" /> : <Sparkles className="w-3.5 h-3.5" />} AI è¯†åˆ«å¹¶æ·»åŠ </button></div>
                <div className="grid grid-cols-2 gap-4 mb-6">
                  <div className="bg-slate-50 p-4 rounded-2xl"><div className="text-[10px] font-bold text-slate-400 uppercase mb-1">è›‹ç™½è´¨</div><div className="flex justify-between items-end mb-2"><input type="number" min="0" value={log.protein === undefined || log.protein === null ? '' : log.protein} onChange={e => saveLog(formatDate(selectedDate), { protein: parseFloat(e.target.value) || 0, isVirtual: false })} className="w-16 bg-transparent font-mono font-bold text-xl outline-none text-slate-800" placeholder="0" /><span className="text-[10px] text-slate-400 mb-1">/ {userProfile.targetProtein}g</span></div><div className="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden"><div className="bg-indigo-500 h-full transition-all duration-500" style={{ width: `${Math.min(100, (log.protein/userProfile.targetProtein)*100)}%` }}></div></div></div>
                  <div className="bg-slate-50 p-4 rounded-2xl"><div className="text-[10px] font-bold text-slate-400 uppercase mb-1">çƒ­é‡</div><div className="flex justify-between items-end mb-2"><input type="number" min="0" value={log.calories === undefined || log.calories === null ? '' : log.calories} onChange={e => saveLog(formatDate(selectedDate), { calories: parseFloat(e.target.value) || 0, isVirtual: false })} className="w-16 bg-transparent font-mono font-bold text-xl outline-none text-slate-800" placeholder="0" /><span className="text-[10px] text-slate-400 mb-1">/ {dayPlan.type === 'Rest' ? userProfile.targetCaloriesRest : userProfile.targetCaloriesTrain}</span></div><div className="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden"><div className={`h-full transition-all duration-500 ${log.calories > 2500 ? 'bg-red-500' : 'bg-green-500'}`} style={{ width: `${Math.min(100, (log.calories/2200)*100)}%` }}></div></div></div>
                </div>
                <div className="border-t border-slate-100 pt-4 px-2"><div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-700 flex items-center gap-2"><Scale className="w-4 h-4 text-indigo-400"/> ä»Šæ—¥æ™¨é‡</span><div className="flex items-center gap-1 bg-slate-50 rounded-lg p-1 pr-3"><input type="number" min="0" step="0.1" value={log.weight === undefined || log.weight === null ? '' : log.weight} onChange={e => saveLog(formatDate(selectedDate), { weight: parseFloat(e.target.value) || 0, isVirtual: false })} className="w-16 bg-transparent p-1 text-center font-bold text-slate-800 outline-none" placeholder="0.0" /><span className="text-xs text-slate-400 font-bold">kg</span></div></div></div>
              </div>

              {log.aiAnalysis ? <div className="bg-slate-800 p-5 rounded-3xl shadow-lg shadow-slate-200 text-slate-300 text-sm italic border-l-4 border-indigo-500 leading-relaxed">"{log.aiAnalysis}"</div> : <button onClick={generateDailySummary} className="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl text-sm font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-200 hover:scale-[1.02] transition-transform active:scale-95"><BrainCircuit className="w-5 h-5" /> ç”Ÿæˆä»Šæ—¥ AI æ•™ç»ƒæ€»ç»“</button>}
            </div>
          );
        };

        function FredFitnessTrackerV5() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState({ name: "Fred", height: 182, startWeight: 80.0, goalWeight: 74.0, startDate: formatDate(new Date()), age: 41, targetProtein: 160, targetCaloriesRest: 1800, targetCaloriesTrain: 2300 });
            const [logs, setLogs] = useState({});
            const [setupMode, setSetupMode] = useState(false);
            const [activeTab, setActiveTab] = useState('log');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [apiKey, setApiKey] = useState(localStorage.getItem('fred_deepseek_key') || DEFAULT_DEEPSEEK_KEY);
            const [aiLoading, setAiLoading] = useState(false);
            const [foodInput, setFoodInput] = useState("");
            const [showSettings, setShowSettings] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [syncError, setSyncError] = useState(null);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                    if (currentUser) {
                        const localData = localStorage.getItem('fred_logs_backup');
                        if (localData) { try { setLogs(JSON.parse(localData)); } catch(e) {} }
                        
                        const docRef = doc(db, "users", currentUser.uid);
                        const unsubDoc = onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (data.profile) setUserProfile(data.profile);
                                if (data.logs) {
                                    setLogs(data.logs);
                                    localStorage.setItem('fred_logs_backup', JSON.stringify(data.logs));
                                }
                                setSetupMode(false);
                            } else { setSetupMode(true); }
                        });
                        return () => unsubDoc();
                    }
                });
                return () => unsubscribe();
            }, []);

            const saveToCloud = async (newProfile, newLogs) => {
                if (newLogs) localStorage.setItem('fred_logs_backup', JSON.stringify(newLogs));
                
                if (!user) { setSyncError("æœªç™»å½•"); return; }
                setIsSyncing(true);
                setSyncError(null);
                try { 
                    await setDoc(doc(db, "users", user.uid), { 
                        profile: newProfile || userProfile, 
                        logs: newLogs || logs 
                    }, { merge: true }); 
                } catch (e) { 
                    console.error("äº‘ç«¯å†™å…¥å¤±è´¥", e);
                    if (e.code === 'permission-denied') {
                        setSyncError("æƒé™ä¸è¶³");
                    } else if (e.code === 'unavailable') {
                         setSyncError("ç½‘ç»œæ–­å¼€");
                    } else {
                        setSyncError("å†™å…¥å¤±è´¥");
                    }
                } finally {
                    setIsSyncing(false);
                }
            };
            
            const saveProfile = (newProfile) => { setUserProfile(newProfile); saveToCloud(newProfile, null); setSetupMode(false); };
            const saveLog = (dateStr, data) => { 
                const newLogs = { ...logs, [dateStr]: { ...logs[dateStr], ...data, date: dateStr } }; 
                setLogs(newLogs); 
                saveToCloud(null, newLogs); 
            };
            const getLog = (dateStr) => {
                if (logs[dateStr]) return logs[dateStr];
                const todayStr = formatDate(new Date());
                if (dateStr < todayStr) return { isVirtual: true, weight: null, calories: 0, protein: 0, workoutCompleted: false, foodLog: [], swaps: {} };
                return { weight: null, protein: 0, calories: 0, workoutCompleted: false, foodLog: [], swaps: {} };
            };

            const handleReset = async () => {
                if (!confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†ä¸å¯æ¢å¤ã€‚")) return;
                if (!user) return;
                const newProfile = { ...userProfile, startDate: formatDate(new Date()) };
                const newLogs = {};
                setUserProfile(newProfile);
                setLogs(newLogs);
                setSetupMode(true); 
                setShowSettings(false);
                try { await setDoc(doc(db, "users", user.uid), { profile: newProfile, logs: newLogs }); } catch (e) { console.error("é‡ç½®å¤±è´¥", e); }
            };

            const callDeepSeek = async (systemPrompt, userPrompt) => {
                const effectiveKey = apiKey || DEFAULT_DEEPSEEK_KEY;
                if (!effectiveKey) { alert("è¯·åœ¨è®¾ç½®ä¸­æ£€æŸ¥ API Key"); return null; }
                try {
                  setAiLoading(true);
                  const controller = new AbortController();
                  const timeoutId = setTimeout(() => controller.abort(), 15000);
                  const response = await fetch("https://api.deepseek.com/chat/completions", { 
                      method: "POST", 
                      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${effectiveKey}` }, 
                      body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], temperature: 0.7 }),
                      signal: controller.signal
                  });
                  clearTimeout(timeoutId);
                  if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
                  const data = await response.json();
                  return data.choices[0].message.content;
                } catch (error) { console.error(error); alert("AI è¿æ¥è¶…æ—¶æˆ–å¤±è´¥"); return null; } finally { setAiLoading(false); }
            };

            const handleFoodAnalysis = async () => {
                if (!foodInput.trim()) return;
                const prompt = `åˆ†æé£Ÿç‰©ï¼š${foodInput}ã€‚è¿”å›çº¯JSONæ ¼å¼ï¼š{"calories": number, "protein": number, "analysis": "string"}`;
                const res = await callDeepSeek("ä½ æ˜¯ä¸€ä¸ªè¥å…»å¸ˆï¼Œåªè¿”å›JSONï¼Œä¸è¦markdownæ ¼å¼", prompt);
                if (res) {
                  try {
                    const cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
                    const startIdx = cleanJson.indexOf('{');
                    const endIdx = cleanJson.lastIndexOf('}');
                    const jsonStr = cleanJson.substring(startIdx, endIdx + 1);
                    const data = JSON.parse(jsonStr);
                    const current = getLog(formatDate(selectedDate));
                    saveLog(formatDate(selectedDate), { 
                        calories: (current.calories || 0) + (data.calories || 0), 
                        protein: (current.protein || 0) + (data.protein || 0), 
                        foodLog: [...(current.foodLog || []), { time: 'åˆšåˆš', text: foodInput, cal: data.calories, pro: data.protein }] 
                    });
                    setFoodInput("");
                  } catch (e) { console.error(e); alert("AI è¿”å›æ ¼å¼è§£æå¤±è´¥ï¼Œè¯·é‡è¯•"); }
                }
            };

            const generateDailySummary = async () => {
                const current = getLog(formatDate(selectedDate));
                const prompt = `æ—¥æœŸ:${formatDate(selectedDate)}, ä½“é‡:${current.weight || 'æœªæµ‹'}, çƒ­é‡:${current.calories}, è›‹ç™½:${current.protein}, è®­ç»ƒ:${current.workoutCompleted?'æ˜¯':'å¦'}ã€‚ç»™Fredä¸€æ®µç®€çŸ­çŠ€åˆ©çš„ç‚¹è¯„ã€‚`;
                const res = await callDeepSeek("ä¸¥æ ¼å¥èº«æ•™ç»ƒ", prompt);
                if (res) saveLog(formatDate(selectedDate), { aiAnalysis: res });
            };

            if (loading) return <div className="h-full flex items-center justify-center text-slate-500 animate-pulse">æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="h-full flex flex-col bg-slate-50 font-sans text-slate-900 overflow-hidden relative">
                    <header className="bg-white p-4 shadow-sm z-30 flex justify-between items-center backdrop-blur-md bg-opacity-80 absolute top-0 w-full">
                        <div className="flex items-center gap-2">
                            {user.photoURL && <img src={user.photoURL} className="w-8 h-8 rounded-full border border-indigo-200"/>}
                            <div><h1 className="font-black text-lg italic text-slate-800 tracking-tighter">FRED<span className="text-indigo-600">.FIT</span></h1></div>
                        </div>
                        <div className="flex gap-3 items-center">
                            <div title={isSyncing ? "æ­£åœ¨åŒæ­¥..." : (syncError ? 'åŒæ­¥å¤±è´¥' : 'äº‘ç«¯å·²åŒæ­¥')} className={`w-3 h-3 rounded-full ${isSyncing ? 'bg-yellow-400 animate-pulse' : (syncError ? 'bg-red-500' : 'bg-green-500')}`}></div>
                            <button onClick={() => signOut(auth)} className="text-slate-400 hover:text-red-500"><LogOut className="w-5 h-5" /></button>
                            <button onClick={() => setShowSettings(!showSettings)} className="text-slate-400 hover:text-indigo-600"><Settings className="w-5 h-5" /></button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-y-auto scrollbar-hide pt-16">
                        {setupMode ? (
                             <div className="p-6 h-full flex flex-col justify-center animate-fade-in bg-slate-900 text-white"><h1 className="text-2xl font-bold mb-4">æ¬¢è¿å¼€å¯æ–°è®¡åˆ’</h1><p className="text-slate-400 mb-6">è¯·é‡æ–°è¾“å…¥ä½ çš„å½“å‰çŠ¶æ€ï¼ŒAIå°†ä¸ºä½ é‡ç½®æ•°æ®ã€‚</p><div className="space-y-4"><div><label className="text-xs text-slate-400">å½“å‰ä½“é‡ (kg)</label><input type="number" value={userProfile.startWeight} onChange={e=>setUserProfile({...userProfile, startWeight: parseFloat(e.target.value)})} className="w-full bg-slate-800 p-3 rounded text-lg font-bold" /></div><div><label className="text-xs text-slate-400">æ–°ç›®æ ‡ä½“é‡ (kg)</label><input type="number" value={userProfile.goalWeight} onChange={e=>setUserProfile({...userProfile, goalWeight: parseFloat(e.target.value)})} className="w-full bg-slate-800 p-3 rounded text-lg font-bold" /></div><button onClick={()=>saveProfile(userProfile)} className="w-full bg-indigo-600 py-3 rounded font-bold">å¼€å§‹è®­ç»ƒ</button></div></div>
                        ) : showSettings ? <SettingsTab apiKey={apiKey} setApiKey={setApiKey} userProfile={userProfile} saveProfile={saveProfile} setSetupMode={setSetupMode} handleReset={handleReset} /> : 
                        (activeTab === 'log' ? <LoggerTab selectedDate={selectedDate} setSelectedDate={setSelectedDate} log={getLog(formatDate(selectedDate))} saveLog={saveLog} userProfile={userProfile} dayPlan={BASE_PLAN[selectedDate.getDay()]} logs={logs} foodInput={foodInput} setFoodInput={setFoodInput} handleFoodAnalysis={handleFoodAnalysis} loading={aiLoading} generateDailySummary={generateDailySummary} isSyncing={isSyncing} syncError={syncError} /> : <HistoryTab userProfile={userProfile} logs={logs} />)}
                    </main>
                    <nav className="bg-white border-t border-slate-100 flex justify-around py-3 pb-6 z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] absolute bottom-0 w-full rounded-t-3xl">
                        <button onClick={() => { setActiveTab('history'); setShowSettings(false); }} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'history' && !showSettings ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400 hover:text-slate-600'}`}><History className="w-6 h-6" /><span className="text-[10px] font-bold mt-1">å†å²/è¶‹åŠ¿</span></button>
                        <button onClick={() => { setActiveTab('log'); setShowSettings(false); setSelectedDate(new Date()); }} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'log' && !showSettings ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400 hover:text-slate-600'}`}><Activity className="w-6 h-6" /><span className="text-[10px] font-bold mt-1">ä»Šæ—¥æ‰“å¡</span></button>
                    </nav>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<FredFitnessTrackerV5 />);

    </script>
</body>
</html>