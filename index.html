<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FRED.FITNESS (V9.7 è§†è§‰ä¼˜åŒ–ç‰ˆ)</title>
    
    <!-- 1. æ§åˆ¶å°å‡€åŒ– -->
    <script>
        const origWarn = console.warn;
        console.warn = function(...args) {
            const msg = args.join(' ');
            if (msg.includes('cdn.tailwindcss.com') || msg.includes('in-browser Babel transformer')) return;
            origWarn.apply(console, args);
        };
        window.onerror = function(msg, url, line, col, error) {
            const box = document.getElementById('error-box');
            if (box) {
                box.style.display = 'block';
                box.innerHTML += `<div><strong>Error:</strong> ${msg}</div>`;
                console.error("Global Error:", error);
            }
            return false;
        };
    </script>

    <!-- 2. æ ·å¼ä¸ä¾èµ– -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { 
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
            background-color: #f8fafc;
            color: #1e293b;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        .bar-3d-green { background: linear-gradient(180deg, #4ade80 0%, #22c55e 100%); }
        .bar-3d-blue { background: linear-gradient(180deg, #818cf8 0%, #6366f1 100%); }
        
        #error-box {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%;
            background: #fee2e2; color: #b91c1c;
            padding: 20px; z-index: 9999;
            border-bottom: 2px solid #ef4444;
            font-family: monospace; font-size: 12px;
        }
    </style>
</head>
<body class="bg-slate-100 h-screen w-screen overflow-hidden flex justify-center items-center">

    <div id="error-box"></div>

    <div id="root" class="w-full h-full max-w-md bg-white shadow-2xl overflow-hidden relative sm:rounded-2xl sm:h-[95vh] sm:border sm:border-slate-200">
        <div class="flex h-full items-center justify-center text-slate-400 text-sm animate-pulse flex-col gap-4">
            <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <span>System Initializing...</span>
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, Component } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Activity, Utensils, Scale, Calendar, Trophy, TrendingDown, 
          Dumbbell, Droplets, BrainCircuit, ChevronRight, AlertTriangle, 
          Settings, Send, Loader2, Save, ChevronLeft, History, 
          CheckCircle2, XCircle, ArrowLeftRight, Sparkles, Flame, Apple, LogOut, Cloud, ChefHat, RefreshCw, Coffee, Target, Zap, Info, Ruler, WifiOff, Leaf
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "firebase/firestore";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBXbO4WzrrHTIIZ7BH6ChSsYrGepg-ymfQ",
            authDomain: "fred-fitness.firebaseapp.com",
            projectId: "fred-fitness",
            storageBucket: "fred-fitness.firebasestorage.app",
            messagingSenderId: "740270431308",
            appId: "1:740270431308:web:245155b5d8de8addaca8e9",
            measurementId: "G-QPYZJ2WKWN"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Failed:", e);
        }

        const DEFAULT_DEEPSEEK_KEY = "sk-72fba3190e5c4147bdd1b27fcab574dc";
        
        const DEFAULT_PROFILE = {
            name: "Fred", currentWeight: 80.0, startWeight: 80.0, goalWeight: 74.0, startDate: new Date().toISOString().split('T')[0], 
            targetProtein: 176, targetCaloriesTrain: 2200, targetFiber: 30,
            age: 30, height: 180, gender: 'male', activity: 'moderate', goalType: 'cut'
        };

        const BASE_PLAN = {
          1: { title: "èƒ¸éƒ¨ & ä¸‰å¤´è‚Œ", type: "Strength", exercises: [{ name: "å¹³æ¿æ é“ƒå§æ¨", sets: "4ç»„ x 10æ¬¡", alternatives: [{name:"å¤§é‡é‡å“‘é“ƒå§æ¨", sets:"4x10"}, {name:"è´Ÿé‡ä¿¯å§æ’‘", sets:"4xåŠ›ç«­"}] }, { name: "ä¸Šæ–œå“‘é“ƒå§æ¨", sets: "4ç»„ x 12æ¬¡", alternatives: [{name:"ä¸‹æ–œä¿¯å§æ’‘", sets:"4x15"}, {name:"å™¨æ¢°æ¨èƒ¸", sets:"4x12"}] }, { name: "ç»³ç´¢ä¸‹å‹", sets: "4ç»„ x 15æ¬¡", alternatives: [{name:"å“‘é“ƒè‡‚å±ˆä¼¸", sets:"4x12"}, {name:"çª„è·ä¿¯å§æ’‘", sets:"4xåŠ›ç«­"}] }, { name: "æ‚¬å‚ä¸¾è…¿", sets: "4ç»„ x åŠ›ç«­", alternatives: [{name:"ä»°å§æŠ¬è…¿", sets:"4x20"}] }] },
          2: { title: "èƒŒéƒ¨ & äºŒå¤´è‚Œ", type: "Strength", exercises: [{ name: "é«˜ä½ä¸‹æ‹‰", sets: "4ç»„ x 12æ¬¡", alternatives: [{name:"å¼•ä½“å‘ä¸Š", sets:"4x8"}, {name:"å¼¹åŠ›å¸¦ä¸‹æ‹‰", sets:"4x20"}] }, { name: "åå§¿åˆ’èˆ¹", sets: "4ç»„ x 12æ¬¡", alternatives: [{name:"å•è‡‚åˆ’èˆ¹", sets:"4x12"}] }, { name: "æ é“ƒå¼¯ä¸¾", sets: "4ç»„ x 12æ¬¡", alternatives: [{name:"å“‘é“ƒå¼¯ä¸¾", sets:"4x12"}] }, { name: "å¹³æ¿æ”¯æ’‘", sets: "4ç»„ x 60ç§’", alternatives: [{name:"æ­»è™«å¼", sets:"4x20"}] }] },
          3: { title: "è…¿éƒ¨ & è‚©éƒ¨", type: "HighIntensity", exercises: [{ name: "æ·±è¹²", sets: "5ç»„ x 10æ¬¡", alternatives: [{name:"é«˜è„šæ¯æ·±è¹²", sets:"5x15"}] }, { name: "å“‘é“ƒæ¨ä¸¾", sets: "4ç»„ x 12æ¬¡", alternatives: [{name:"å€’ç«‹æ’‘", sets:"4x8"}] }, { name: "ä¾§å¹³ä¸¾", sets: "5ç»„ x 15æ¬¡", alternatives: [{name:"ç›´ç«‹åˆ’èˆ¹", sets:"4x12"}] }, { name: "è…¿å±ˆä¼¸", sets: "3ç»„ x 15æ¬¡", alternatives: [{name:"ç®­æ­¥è¹²", sets:"3x20"}] }] },
          4: { title: "æœ‰æ°§ç‡ƒè„‚", type: "Cardio", exercises: [{ name: "å·è…¹", sets: "4ç»„ x 20æ¬¡", alternatives: [{name:"æ‘¸è†å·è…¹", sets:"4x20"}] }, { name: "ä¿„ç½—æ–¯è½¬ä½“", sets: "4ç»„ x 20æ¬¡", alternatives: [{name:"ä¾§æ”¯æ’‘", sets:"4x45s"}] }, { name: "ç™»å±±è·‘", sets: "4ç»„ x 30ç§’", alternatives: [{name:"å¼€åˆè·³", sets:"4x45s"}] }, { name: "çœŸç©ºè…¹", sets: "5ç»„ x 30ç§’", alternatives: [{name:"å¹³æ¿æ”¯æ’‘", sets:"4x60s"}] }] },
          5: { title: "æ·±åº¦æ¢å¤", type: "Rest", exercises: [{ name: "æ³¡æ²«è½´æ”¾æ¾", sets: "20åˆ†é’Ÿ", alternatives: [{name:"ç‘œä¼½", sets:"20m"}] }, { name: "æ¸©æ°´æ¾¡", sets: "15åˆ†é’Ÿ", alternatives: [{name:"å†¥æƒ³", sets:"10m"}] }] },
          6: { title: "HIIT", type: "HIIT", exercises: [{ name: "æ³¢æ¯”è·³", sets: "10ä¸ª x 5ç»„", alternatives: [{name:"ç®€æ˜“æ³¢æ¯”", sets:"10x5"}] }, { name: "å£¶é“ƒæ‘‡æ‘†", sets: "20ä¸ª x 4ç»„", alternatives: [{name:"è‡€æ¡¥", sets:"20x4"}] }, { name: "æˆ˜ç»³", sets: "30ç§’ x 4ç»„", alternatives: [{name:"å¿«é€Ÿæ‹³å‡»", sets:"45sx4"}] }] },
          0: { title: "æˆ·å¤–è€åŠ›", type: "ActiveRecovery", exercises: [{ name: "æˆ·å¤–éª‘è¡Œ", sets: "60åˆ†é’Ÿ+", alternatives: [{name:"å®¤å†…å•è½¦", sets:"45m"}] }, { name: "å…¨èº«æ‹‰ä¼¸", sets: "20åˆ†é’Ÿ", alternatives: [{name:"ç­‹è†œæª", sets:"15m"}] }] }
        };

        const MEAL_PLANS = {
            Strength: { breakfast: {main: "å…¨éº¦ä¸‰æ˜æ²»+ç‰›å¥¶", alt: "ç‡•éº¦+è›‹ç™½ç²‰"}, lunch: {main: "é¸¡èƒ¸è‚‰+æ‚ç²®é¥­", alt: "ç˜¦ç‰›è‚‰+çº¢è–¯"}, dinner: {main: "æ¸…è’¸é±¼+è”¬èœ", alt: "è™¾ä»è±†è…æ±¤"}, snack: {main: "è›‹ç™½ç²‰+é¦™è•‰", alt: "æ— ç³–é…¸å¥¶"} },
            HighIntensity: { breakfast: {main: "æ°´ç…®è›‹3ä¸ª+ç‰ç±³", alt: "å…¨éº¦é¢åŒ…+èŠ±ç”Ÿé…±"}, lunch: {main: "ç‰›è‚‰ç›–é¥­(å°‘æ²¹)", alt: "å»çš®é¸¡è…¿é¥­"}, dinner: {main: "é‡‘æªé±¼æ²™æ‹‰", alt: "ç˜¦è‚‰ä¸¸å­æ±¤"}, snack: {main: "ç‰›è‚‰å¹²", alt: "è¿åŠ¨é¥®æ–™"} },
            Rest: { breakfast: {main: "é»‘å’–å•¡+é¸¡è›‹", alt: "è±†æµ†+é¸¡è‚‰è‚ "}, lunch: {main: "ç‰›æ’æ²™æ‹‰", alt: "ç™½ç¼è™¾+é’èœ"}, dinner: {main: "é»„ç“œé¸¡è›‹æ±¤", alt: "ç•ªèŒ„èœèŠ±"}, snack: {main: "åšæœ", alt: "é…ªè›‹ç™½"} }
        };

        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-full flex flex-col items-center justify-center p-6 bg-slate-50 text-slate-800">
                            <AlertTriangle className="w-16 h-16 text-red-500 mb-4" />
                            <h2 className="text-xl font-bold mb-2">ç³»ç»Ÿé‡åˆ°é—®é¢˜</h2>
                            <p className="text-xs text-slate-500 mb-6 bg-slate-100 p-2 rounded text-center">{this.state.error?.toString()}</p>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">é‡ç½®ä¿®å¤</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- å­ç»„ä»¶ ---

        const LoginScreen = ({ onLogin }) => {
            const handleLogin = async () => {
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } catch (err) { alert("ç™»å½•é”™è¯¯: " + err.message); }
            };
            return (
                <div className="h-full flex flex-col items-center justify-center p-6 bg-slate-900 text-white animate-fade-in">
                    <Activity className="w-16 h-16 text-indigo-500 mb-6" />
                    <h1 className="text-3xl font-black mb-2 tracking-widest">FRED.FITNESS</h1>
                    <p className="text-slate-400 mb-10 text-center text-sm font-medium tracking-wide">V9.7 è§†è§‰ä¼˜åŒ–ç‰ˆ</p>
                    <button onClick={handleLogin} className="w-full max-w-xs bg-white text-slate-900 font-bold py-3.5 px-4 rounded-2xl flex items-center justify-center gap-3 hover:scale-105 transition-all shadow-lg">ä½¿ç”¨ Google è´¦å·ç™»å½•</button>
                </div>
            );
        };

        const SettingsTab = ({ apiKey, setApiKey, userProfile, saveProfile, handleReset }) => {
            const [localProfile, setLocalProfile] = useState(userProfile || DEFAULT_PROFILE);
            useEffect(() => { if(userProfile) setLocalProfile(userProfile); }, [userProfile]);
            const handleChange = (field, val) => setLocalProfile(prev => ({...prev, [field]: val}));
            
            const autoCalculate = () => {
                const w = parseFloat(localProfile.currentWeight) || 80;
                const h = parseFloat(localProfile.height) || 180;
                const a = parseFloat(localProfile.age) || 30;
                const gender = localProfile.gender || 'male';
                
                let bmr = (10 * w) + (6.25 * h) - (5 * a);
                bmr += (gender === 'male' ? 5 : -161);
                
                const tdee = bmr * 1.55;
                let goalCalories = tdee;
                if (localProfile.goalType === 'cut') goalCalories -= 500; 
                else if (localProfile.goalType === 'bulk') goalCalories += 300; 
                
                const protein = Math.round(w * 2.2); 
                const fiber = 35; 

                setLocalProfile(prev => ({ 
                    ...prev, 
                    targetCaloriesTrain: Math.round(goalCalories), 
                    targetProtein: protein, 
                    targetFiber: fiber 
                }));
                
                alert(`âš¡ï¸ æ™ºèƒ½æ¨ç®—å®Œæˆï¼\n\nåŸºç¡€ä»£è°¢(BMR): ${Math.round(bmr)}\næ€»æ¶ˆè€—(TDEE): ${Math.round(tdee)}\n\nå»ºè®®ç›®æ ‡ï¼š\nçƒ­é‡: ${Math.round(goalCalories)} kcal\nè›‹ç™½è´¨: ${protein} g\nçº¤ç»´: ${fiber} g`);
            };

            return (
              <div className="p-5 space-y-6 animate-fade-in bg-[#f8f9fa] h-full overflow-y-auto pb-24">
                <div className="flex items-center justify-between"><h2 className="text-xl font-bold text-slate-800">è´¦æˆ·è®¾ç½®</h2><button onClick={autoCalculate} className="bg-orange-500 text-white px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1"><Zap className="w-3 h-3"/> æ™ºèƒ½æ¨ç®—</button></div>
                <div className="space-y-4">
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                      <div className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2"><Ruler className="w-4 h-4 text-indigo-500"/> èº«ä½“å‚æ•°</div>
                      <div className="grid grid-cols-2 gap-3">
                          <div><label className="text-[10px] text-slate-400 uppercase mb-1 block">ä½“é‡ (kg)</label><input type="number" value={localProfile.currentWeight} onChange={e=>handleChange('currentWeight', parseFloat(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm font-bold" /></div>
                          <div><label className="text-[10px] text-slate-400 uppercase mb-1 block">ç›®æ ‡ (kg)</label><input type="number" value={localProfile.goalWeight} onChange={e=>handleChange('goalWeight', parseFloat(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm font-bold" /></div>
                          <div><label className="text-[10px] text-slate-400 uppercase mb-1 block">èº«é«˜ (cm)</label><input type="number" value={localProfile.height} onChange={e=>handleChange('height', parseFloat(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm" /></div>
                          <div><label className="text-[10px] text-slate-400 uppercase mb-1 block">å¹´é¾„</label><input type="number" value={localProfile.age} onChange={e=>handleChange('age', parseFloat(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm" /></div>
                          <div><label className="text-[10px] text-slate-400 uppercase mb-1 block">æ€§åˆ«</label><select value={localProfile.gender} onChange={e=>handleChange('gender', e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm"><option value="male">ç”·</option><option value="female">å¥³</option></select></div>
                      </div>
                      <div className="mt-2">
                          <label className="text-[10px] text-slate-400 uppercase mb-1 block">é˜¶æ®µç›®æ ‡</label>
                          <select value={localProfile.goalType} onChange={e=>handleChange('goalType', e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm font-bold text-slate-700 outline-none">
                              <option value="cut">ğŸ”¥ æé€Ÿå‡è„‚ (çƒ­é‡ç¼ºå£å¤§)</option><option value="recomp">âš–ï¸ å¢è‚Œå‡è„‚ (çƒ­é‡å¹³è¡¡)</option><option value="bulk">ğŸ’ª åŠ›é‡å¢è‚Œ (çƒ­é‡ç›ˆä½™)</option>
                          </select>
                      </div>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                      <div className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2"><Target className="w-4 h-4 text-indigo-500"/> è¥å…»ç›®æ ‡ (è‡ªåŠ¨/æ‰‹åŠ¨)</div>
                      <div className="grid grid-cols-3 gap-2">
                          <div><label className="text-[10px] text-slate-400 uppercase mb-1 block text-center">çƒ­é‡ (kcal)</label><input type="number" value={localProfile.targetCaloriesTrain} onChange={e=>handleChange('targetCaloriesTrain', parseFloat(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm text-center font-mono font-bold" /></div>
                          <div><label className="text-[10px] text-slate-400 uppercase mb-1 block text-center">è›‹ç™½è´¨ (g)</label><input type="number" value={localProfile.targetProtein} onChange={e=>handleChange('targetProtein', parseFloat(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm text-center font-mono font-bold" /></div>
                          <div><label className="text-[10px] text-slate-400 uppercase mb-1 block text-center">çº¤ç»´ (g)</label><input type="number" value={localProfile.targetFiber} onChange={e=>handleChange('targetFiber', parseFloat(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm text-center font-mono font-bold" /></div>
                      </div>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                      <div className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2"><BrainCircuit className="w-4 h-4 text-indigo-500"/> DeepSeek Key</div>
                      <input type="password" value={apiKey} onChange={e => { setApiKey(e.target.value); localStorage.setItem('fred_deepseek_key', e.target.value); }} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm font-mono" placeholder="sk-..." />
                  </div>
                  <button onClick={() => {saveProfile(localProfile); alert("è®¾ç½®å·²ä¿å­˜")}} className="w-full py-3 bg-slate-900 text-white rounded-xl text-sm font-bold shadow-lg">ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
                  <div className="pt-4 border-t border-slate-200">
                      <button onClick={handleReset} className="w-full py-3 bg-white text-red-500 rounded-xl text-sm font-bold border border-red-100 flex items-center justify-center gap-2 hover:bg-red-50"><RefreshCw className="w-4 h-4"/> é‡ç½®è®¡åˆ’ (å±é™©)</button>
                  </div>
                </div>
              </div>
            );
        };

        const HistoryTab = ({ userProfile = DEFAULT_PROFILE, logs = {} }) => {
          const historyData = useMemo(() => {
            const days = []; const today = new Date();
            for (let i = 13; i >= 0; i--) {
                const d = new Date(); d.setDate(today.getDate() - i);
                const dateStr = formatDate(d); let log = logs[dateStr];
                if (!log) log = { isVirtual: true, weight: 0, calories: 0, protein: 0, workoutCompleted: false };
                else log = { ...log, weight: Number(log.weight||0), calories: Number(log.calories||0) };
                days.push({ date: dateStr, ...log });
            }
            return days;
          }, [logs]);

          const currentWeight = historyData.slice().reverse().find(d => d.weight > 0)?.weight || userProfile.startWeight || 80;
          const startW = userProfile.startWeight || 80;
          const goalW = userProfile.goalWeight || 74;
          const progress = (startW - currentWeight).toFixed(1);
          
          let plotData = [...historyData];
          if (plotData.every(d => !d.weight)) plotData[0].weight = startW; 

          const validWeights = plotData.filter(d => d.weight > 0).map(d => d.weight);
          const allYPoints = [...validWeights, goalW, startW];
          const minW = Math.min(...allYPoints) - 1; 
          const maxW = Math.max(...allYPoints) + 1;
          const range = maxW - minW || 1;
          const goalY = 100 - ((goalW - minW) / range) * 100;

          const points = plotData.map((day, index) => {
              if (!day.weight || day.weight <= 0) return null;
              const x = (index / 13) * 100; 
              const y = 100 - ((day.weight - minW) / range) * 100;
              return { x, y, val: day.weight, date: day.date.slice(5) };
          }).filter(p => p !== null);

          const linePath = points.map(p => `${p.x},${p.y}`).join(" ");
          let areaPath = "";
          if (points.length > 0) {
              const first = points[0]; const last = points[points.length - 1];
              areaPath = `${linePath} L${last.x},100 L${first.x},100 Z`;
          }

          const calculateScore = (day) => {
              if (day.isVirtual) return 0;
              let score = 0;
              if (day.workoutCompleted) score += 40;
              if (day.protein >= (userProfile.targetProtein || 160) * 0.8) score += 30;
              if (day.calories > 0) score += 30; 
              return Math.min(100, Math.round(score));
          };

          return (
            <div className="space-y-6 animate-fade-in pb-24 p-4 bg-[#f8f9fa] h-full overflow-y-auto">
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
                <div className="relative z-10">
                    <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">è·ç¦»ç›®æ ‡è¿˜å·® {Math.abs(currentWeight - goalW).toFixed(1)}kg</h2>
                    <div className="flex items-baseline gap-2 mb-4">
                        <span className="text-5xl font-black text-slate-800 tracking-tighter">{currentWeight}</span>
                        <span className="text-lg text-slate-500 font-medium">kg</span>
                        <div className="ml-auto flex flex-col items-end">
                            <span className="text-[10px] text-slate-400 uppercase font-bold">Total Loss</span>
                            <span className={`text-lg font-bold ${progress >= 0 ? 'text-green-500' : 'text-red-500'}`}>{progress} kg</span>
                        </div>
                    </div>
                    <div className="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
                        <div className="bg-gradient-to-r from-indigo-500 to-purple-500 h-full transition-all duration-1000 ease-out" style={{ width: `${Math.min(100, Math.max(0, (progress / (startW - goalW)) * 100))}%` }}></div>
                    </div>
                </div>
              </div>

              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="font-bold text-slate-800 flex items-center gap-2"><Activity className="w-5 h-5 text-indigo-500" /> ä½“é‡è¶‹åŠ¿</h2>
                    <span className="text-[10px] font-bold text-slate-300">Min: {minW.toFixed(1)} / Max: {maxW.toFixed(1)}</span>
                </div>
                <div className="h-56 w-full relative">
                    <div className="absolute left-0 top-0 h-full flex flex-col justify-between text-[9px] text-slate-300 font-mono py-2 select-none z-0">
                        <span>{maxW.toFixed(1)}</span><span>{((maxW+minW)/2).toFixed(1)}</span><span>{minW.toFixed(1)}</span>
                    </div>
                    <div className="absolute left-6 right-0 top-0 h-full">
                        <div className="absolute w-full border-t-2 border-dashed border-green-300 left-0 z-0 transition-all duration-700" style={{top: `${Math.min(100, Math.max(0, goalY))}%`}}></div>
                        <div className="absolute right-0 text-[9px] text-white bg-green-400 px-1.5 py-0.5 rounded-full -mt-2.5 z-10 font-bold shadow-sm" style={{top: `${Math.min(100, Math.max(0, goalY))}%`}}>Target {goalW}</div>
                        
                        <svg className="w-full h-full overflow-visible z-10 relative" viewBox="0 0 100 100" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#6366f1" stopOpacity="0.2"/><stop offset="100%" stopColor="#6366f1" stopOpacity="0"/></linearGradient>
                            </defs>
                            {points.length > 1 && <path d={areaPath} fill="url(#chartGradient)" vectorEffect="non-scaling-stroke" />}
                            {points.length > 1 && <polyline fill="none" stroke="#6366f1" strokeWidth="2.5" points={linePath} strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke" />}
                        </svg>

                        {points.map((p, i) => (
                            <div key={i} className="absolute w-3 h-3 bg-white border-[2.5px] border-indigo-500 rounded-full shadow-md z-20 transition-transform hover:scale-150 group flex justify-center" style={{left: `calc(${p.x}% - 6px)`, top: `calc(${p.y}% - 6px)`}}>
                                <div className="absolute bottom-4 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap font-bold pointer-events-none">{p.val}kg</div>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="flex justify-between text-[9px] text-slate-300 mt-2 pl-6 font-mono">
                    <span>{historyData[0].date.slice(5)}</span><span>{historyData[7].date.slice(5)}</span><span>ä»Šå¤©</span>
                </div>
              </div>

              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 className="font-bold text-slate-800 mb-6 flex items-center gap-2"><Calendar className="w-5 h-5 text-orange-500" /> æ¯æ—¥ç»¼åˆå¾—åˆ†</h2>
                <div className="flex justify-between items-end gap-1 h-36 pl-6 relative">
                    <div className="absolute left-0 top-0 bottom-0 w-px bg-slate-100"></div>
                    {historyData.map((day, i) => {
                        const score = calculateScore(day);
                        let colorClass = "from-slate-200 to-slate-300";
                        if (score >= 80) colorClass = "bar-3d-green"; else if (score > 0) colorClass = "bar-3d-blue";
                        const isToday = day.date === new Date().toISOString().split('T')[0];
                        const showLabel = i % 2 === 0 || i === 13;
                        return (
                            <div key={i} className="flex-1 flex flex-col items-center justify-end gap-1 h-full group relative">
                                <div className={`text-[9px] font-bold mb-1 transition-all ${score>0?'text-slate-500':'text-transparent'}`}>{score}</div>
                                <div className="w-full h-full bg-slate-50/50 rounded-t-sm relative flex items-end">
                                    <div className={`w-full rounded-t-sm transition-all duration-1000 ease-out ${colorClass} ${isToday ? 'ring-1 ring-inset ring-indigo-300' : ''}`} style={{height: `${score}%`}}></div>
                                </div>
                                <div className={`text-[8px] font-mono whitespace-nowrap ${isToday ? 'text-indigo-600 font-bold' : 'text-slate-300'} ${showLabel?'opacity-100':'opacity-0'}`}>{day.date.slice(8)}</div>
                            </div>
                        );
                    })}
                </div>
              </div>
            </div>
          );
        };

        const LoggerTab = ({ 
          selectedDate, setSelectedDate, log, saveLog, userProfile, dayPlan, logs,
          foodInput, setFoodInput, handleFoodAnalysis, loading, handleDayEndAnalysis
        }) => {
          const isToday = formatDate(selectedDate) === formatDate(new Date());
          useEffect(() => { setFoodInput(""); }, [selectedDate]);

          // --- ä¿®å¤ï¼šç©ºå€¼ä¿æŠ¤ ---
          const getMealPlan = () => {
              const safeDayPlan = dayPlan || BASE_PLAN[1];
              let type = safeDayPlan.type; 
              if (type !== 'Strength' && type !== 'HighIntensity') type = 'Rest'; 
              const plan = MEAL_PLANS[type] || MEAL_PLANS['Strength']; 
              if (!plan) return { breakfast: {}, lunch: {}, dinner: {}, snack: {} };
              return { breakfast: plan.breakfast, lunch: plan.lunch, dinner: plan.dinner, snack: plan.snack }
          };
          const dailyMeal = log.generatedDiet || getMealPlan();
          
          const activePlan = log.generatedPlan || dayPlan || BASE_PLAN[selectedDate.getDay()];
          const isGenerated = !!log.generatedPlan;

          const toggleExercise = (index) => {
            const currentSwaps = log.swaps || {};
            const exercise = activePlan.exercises[index];
            if (!exercise.alternatives || exercise.alternatives.length === 0) return;
            const currentAltIndex = currentSwaps[index];
            let nextAltIndex = (currentAltIndex === undefined) ? 0 : (currentAltIndex < exercise.alternatives.length - 1 ? currentAltIndex + 1 : undefined);
            const newSwaps = { ...currentSwaps };
            if (nextAltIndex === undefined) delete newSwaps[index]; else newSwaps[index] = nextAltIndex;
            saveLog(formatDate(selectedDate), { swaps: newSwaps, isVirtual: false });
          };

          // Helper: è·å–é¢œè‰²ç±» (V9.7 æ–°é€»è¾‘)
          const getProgressColor = (current, target, isCalorie = false) => {
              if (!current || current === 0) return "bg-slate-50 border-slate-100 text-slate-800";
              const ratio = current / (target || 1);
              
              if (isCalorie) {
                  // çƒ­é‡é€»è¾‘: <100% ç»¿, >100% é»„, >110% çº¢
                  if (ratio > 1.1) return "bg-red-50 border-red-200 text-red-800"; // ä¸¥é‡è¶…æ ‡
                  if (ratio > 1.0) return "bg-yellow-50 border-yellow-200 text-yellow-800"; // è½»å¾®è¶…æ ‡
                  return "bg-green-50 border-green-200 text-green-800"; // åˆ¶é€ ç¼ºå£ (å¥½!)
              } else {
                  // è¥å…»ç´ é€»è¾‘: >=100% ç»¿, >=70% é»„, <70% çº¢
                  if (ratio >= 1.0) return "bg-green-50 border-green-200 text-green-800"; // è¾¾æ ‡
                  if (ratio >= 0.7) return "bg-yellow-50 border-yellow-200 text-yellow-800"; // æ¥è¿‘
                  return "bg-red-50 border-red-200 text-red-800"; // ä¸è¶³
              }
          };

          return (
            <div className="space-y-5 animate-fade-in pb-24 p-4 bg-[#f8f9fa] h-full overflow-y-auto">
              <div className="flex items-center justify-between bg-white/80 p-3 rounded-2xl shadow-sm sticky top-0 z-20 border border-white/50 backdrop-blur-md">
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() - 1); setSelectedDate(d); }} className="p-2 text-slate-500 hover:text-slate-800"><ChevronLeft className="w-5 h-5" /></button>
                <div className="text-center">
                  <div className="font-bold text-slate-800 flex items-center justify-center gap-2 text-lg">
                    {isToday && <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>}
                    {selectedDate.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}
                  </div>
                  <div className="text-[10px] text-indigo-500 font-bold uppercase mt-0.5 tracking-wider flex items-center justify-center gap-1">{isGenerated && <Sparkles className="w-3 h-3"/>} {activePlan.title}</div>
                </div>
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() + 1); setSelectedDate(d); }} className="p-2 text-slate-500 hover:text-slate-800"><ChevronRight className="w-5 h-5" /></button>
              </div>

              <div className={`bg-white p-6 rounded-2xl shadow-sm border-l-4 transition-all duration-300 ${log.workoutCompleted ? 'border-green-500' : 'border-indigo-500'}`}>
                <div className="flex justify-between items-center mb-5">
                  <h3 className="font-bold text-slate-800 flex items-center gap-2"><Dumbbell className="w-5 h-5 text-indigo-500" /> {isGenerated ? "AI è®¡åˆ’" : "ä»Šæ—¥è®­ç»ƒ"}</h3>
                  <button onClick={() => saveLog(formatDate(selectedDate), { workoutCompleted: !log.workoutCompleted })} className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${log.workoutCompleted ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-400'}`}>{log.workoutCompleted ? 'å·²å®Œæˆ' : 'æ‰“å¡'}</button>
                </div>
                <div className="space-y-4">
                  {activePlan.exercises.map((ex, i) => {
                      const swapIndex = log.swaps ? log.swaps[i] : undefined;
                      const isSwapped = swapIndex !== undefined;
                      const displayEx = isSwapped ? ex.alternatives[swapIndex] : ex;
                      const hasAlts = ex.alternatives && ex.alternatives.length > 0;
                      return (
                          <div key={i} className="flex justify-between items-start border-b border-slate-50 pb-3 last:border-0 group">
                            <div className="flex-1">
                              <div className="flex items-center gap-2"><span className={`font-bold text-sm ${isSwapped ? 'text-indigo-600' : 'text-slate-700'}`}>{displayEx.name}</span>{isSwapped && <span className="text-[9px] bg-indigo-50 text-indigo-500 px-1.5 py-0.5 rounded font-bold">æ›¿ä»£</span>}</div>
                              <div className="text-xs text-slate-400 font-mono mt-1">{displayEx.sets} {ex.note && `Â· ${ex.note}`}</div>
                            </div>
                            {hasAlts && <button onClick={() => toggleExercise(i)} className="p-2 text-slate-300 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all"><ArrowLeftRight className="w-4 h-4" /></button>}
                          </div>
                      );
                  })}
                </div>
              </div>

              {/* ä¿®å¤ï¼šä½¿ç”¨ ?. é˜²æ­¢ç™½å± */}
              <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-5 rounded-3xl shadow-sm border border-orange-100">
                  <div className="flex items-center gap-2 mb-3 font-bold text-orange-800"><ChefHat className="w-5 h-5"/> ä¸»å¨æ¨è</div>
                  <div className="space-y-3">
                      <div className="bg-white/60 p-3 rounded-xl"><div className="text-[10px] text-orange-400 font-bold uppercase mb-1">æ—©é¤</div><div className="text-sm font-medium text-slate-700">{dailyMeal?.breakfast?.main || 'æš‚æ— '}</div></div>
                      <div className="bg-white/60 p-3 rounded-xl"><div className="text-[10px] text-orange-400 font-bold uppercase mb-1">åˆé¤</div><div className="text-sm font-medium text-slate-700">{dailyMeal?.lunch?.main || 'æš‚æ— '}</div></div>
                      <div className="bg-white/60 p-3 rounded-xl"><div className="text-[10px] text-orange-400 font-bold uppercase mb-1">æ™šé¤</div><div className="text-sm font-medium text-slate-700">{dailyMeal?.dinner?.main || 'æš‚æ— '}</div></div>
                      <div className="bg-indigo-50/80 p-3 rounded-xl border border-indigo-100"><div className="text-[10px] text-indigo-500 font-bold uppercase mb-1">åŠ é¤</div><div className="text-sm font-medium text-indigo-900">{dailyMeal?.snack?.main || 'æš‚æ— '}</div></div>
                  </div>
              </div>

              <div className="bg-white p-6 rounded-2xl shadow-sm">
                <div className="flex items-center gap-2 mb-5 font-bold text-slate-800"><Utensils className="w-5 h-5 text-indigo-500" /> é¥®é£Ÿè®°å½•</div>
                <div className="bg-slate-50 p-1 rounded-xl mb-6 border border-slate-200 relative focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                  <textarea value={foodInput} onChange={e => setFoodInput(e.target.value)} placeholder="è®°å½•å…¨å¤©é¥®é£Ÿï¼šæ—©é¥­...åˆé¥­..." className="w-full bg-transparent p-4 text-sm rounded-xl outline-none h-24 resize-none mb-10 placeholder-slate-400 text-slate-700" />
                  <button onClick={handleFoodAnalysis} disabled={loading} className="absolute bottom-2 right-2 bg-slate-800 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all shadow-md active:scale-95">{loading ? <Loader2 className="w-3.5 h-3.5 animate-spin" /> : <Sparkles className="w-3.5 h-3.5" />} è¯†åˆ«</button>
                </div>
                
                {/* ä¿®å¤ï¼š4æ ¼çŸ©é˜µ + æ™ºèƒ½å˜è‰² + åŠ å®½è¾“å…¥æ¡† (w-20) */}
                <div className="grid grid-cols-2 gap-3 mb-6">
                  {/* è›‹ç™½è´¨ */}
                  <div className={`p-3 rounded-xl text-center border transition-colors ${getProgressColor(log.protein, userProfile.targetProtein)}`}>
                    <div className="text-[10px] font-bold uppercase mb-1 opacity-70">è›‹ç™½è´¨</div>
                    <div className="flex justify-center items-end gap-0.5">
                      <input type="number" value={log.protein || ''} onChange={e => saveLog(formatDate(selectedDate), { protein: parseFloat(e.target.value) || 0 })} className="w-20 bg-transparent font-mono font-bold text-lg outline-none text-center p-0" placeholder="0" />
                      <span className="text-[8px] opacity-60 mb-1">/{userProfile.targetProtein}</span>
                    </div>
                  </div>
                  {/* çƒ­é‡ (é™åˆ¶å‹é€»è¾‘) */}
                  <div className={`p-3 rounded-xl text-center border transition-colors ${getProgressColor(log.calories, userProfile.targetCaloriesTrain, true)}`}>
                    <div className="text-[10px] font-bold uppercase mb-1 opacity-70">çƒ­é‡</div>
                    <div className="flex justify-center items-end gap-0.5">
                      <input type="number" value={log.calories || ''} onChange={e => saveLog(formatDate(selectedDate), { calories: parseFloat(e.target.value) || 0 })} className="w-20 bg-transparent font-mono font-bold text-lg outline-none text-center p-0" placeholder="0" />
                      <span className="text-[8px] opacity-60 mb-1">/{userProfile.targetCaloriesTrain}</span>
                    </div>
                  </div>
                  {/* çº¤ç»´ */}
                  <div className={`p-3 rounded-xl text-center border transition-colors ${getProgressColor(log.fiber, userProfile.targetFiber)}`}>
                    <div className="text-[10px] font-bold uppercase mb-1 flex justify-center gap-1 opacity-70"><Leaf className="w-3 h-3"/>çº¤ç»´</div>
                    <div className="flex justify-center items-end gap-0.5">
                      <input type="number" value={log.fiber || ''} onChange={e => saveLog(formatDate(selectedDate), { fiber: parseFloat(e.target.value) || 0 })} className="w-20 bg-transparent font-mono font-bold text-lg outline-none text-center p-0" placeholder="0" />
                      <span className="text-[8px] opacity-60 mb-1">/{userProfile.targetFiber}</span>
                    </div>
                  </div>
                  {/* ä½“é‡ (ä¿æŒä¸­æ€§è‰²) */}
                  <div className="bg-slate-50 p-3 rounded-xl text-center border border-slate-100">
                    <div className="text-[10px] font-bold text-slate-400 uppercase mb-1">ä½“é‡</div>
                    <div className="flex justify-center items-end gap-0.5">
                      <input type="number" step="0.1" value={log.weight || ''} onChange={e => saveLog(formatDate(selectedDate), { weight: parseFloat(e.target.value) || 0 })} className="w-20 bg-transparent font-mono font-bold text-lg outline-none text-slate-800 text-center p-0" placeholder="0.0" />
                      <span className="text-[8px] text-slate-400 mb-1">kg</span>
                    </div>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-3 pt-2">
                  <button onClick={()=>saveLog(formatDate(selectedDate), {})} className="col-span-1 py-3.5 bg-white border border-slate-200 text-slate-500 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-slate-50 transition-colors shadow-sm"><Save className="w-4 h-4"/> æš‚å­˜è¿›åº¦</button>
                  {isToday && <button onClick={()=>handleDayEndAnalysis(foodInput)} disabled={loading} className="col-span-2 py-3.5 bg-indigo-600 text-white rounded-xl text-xs font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all active:scale-95">{loading ? <Loader2 className="w-4 h-4 animate-spin"/> : <Target className="w-4 h-4"/>} {loading ? "AI æ€è€ƒä¸­..." : "ç»“æŸæ‰“å¡ & å…¨é‡åˆ†æ"}</button>}
              </div>
              {log.aiAnalysis && <div className="mt-4 bg-slate-200 p-4 rounded-xl text-xs text-slate-600 italic leading-relaxed border-l-4 border-slate-400">ğŸ’¡ æ•™ç»ƒç‚¹è¯„ï¼š{log.aiAnalysis}</div>}
            </div>
          );
        };

        function FredFitnessV8() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState(DEFAULT_PROFILE);
            const [logs, setLogs] = useState({});
            const [activeTab, setActiveTab] = useState('log');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [setupMode, setSetupMode] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);
            const [foodInput, setFoodInput] = useState("");
            const [apiKey, setApiKey] = useState(localStorage.getItem('fred_deepseek_key') || DEFAULT_DEEPSEEK_KEY);
            const [syncError, setSyncError] = useState(null);

            useEffect(() => {
                if (!auth) { setLoading(false); return; }
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u); setLoading(false);
                    if (u) {
                        onSnapshot(doc(db, "users", u.uid), (doc) => {
                            if (doc.exists()) {
                                const d = doc.data();
                                if (d.profile) setUserProfile(prev => ({...prev, ...d.profile}));
                                if (d.logs) setLogs(d.logs);
                                setSetupMode(false);
                            } else setSetupMode(true);
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            const saveToCloud = (p, l) => { 
                if(user && db) {
                    setDoc(doc(db, "users", user.uid), {profile: p||userProfile, logs: l||logs}, {merge:true})
                    .catch(e => setSyncError("äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™"));
                }
            };
            const saveProfile = (p) => { setUserProfile(p); saveToCloud(p, null); setSetupMode(false); setShowSettings(false); };
            const saveLog = (d, data) => { const nl = {...logs, [d]: {...logs[d], ...data}}; setLogs(nl); saveToCloud(null, nl); };

            const handleReset = async () => {
                if(!confirm("âš ï¸ è­¦å‘Šï¼šè¿™å°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼")) return;
                const newP = {...userProfile, startDate: formatDate(new Date())};
                setUserProfile(newP); setLogs({}); setSetupMode(true); setShowSettings(false);
                if(user && db) await setDoc(doc(db, "users", user.uid), {profile: newP, logs: {}});
            };

            const callDeepSeek = async (sys, usr) => {
                setAiLoading(true);
                try {
                    const res = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST", headers: {"Content-Type":"application/json", "Authorization":`Bearer ${apiKey}`},
                        body: JSON.stringify({model:"deepseek-chat", messages:[{role:"system",content:sys}, {role:"user",content:usr}]})
                    });
                    const data = await res.json();
                    return data.choices[0].message.content;
                } catch(e) { alert("AI Error"); return null; } finally { setAiLoading(false); }
            };

            const handleDayEndAnalysis = async (foodText) => {
                const today = formatDate(selectedDate);
                const tmr = new Date(selectedDate); tmr.setDate(tmr.getDate()+1);
                
                // ä¿®å¤ï¼šå¼ºåˆ¶ä¸­æ–‡æŒ‡ä»¤
                const prompt = `Today: ${today}. Food: ${foodText}. Goal: ${userProfile.goalType}.
                Stats: Weight ${userProfile.currentWeight}kg.
                Task: 
                1. Analyze nutrition of food (calories, protein, fiber).
                2. Give feedback for today (IN CHINESE).
                3. Create workout & diet plan for tomorrow (IN CHINESE).
                
                Return JSON ONLY: 
                {"nutrition":{cal:int,pro:int,fiber:int}, "feedback":"ä¸­æ–‡ç‚¹è¯„", "tomorrow":{"workout":{title:"ä¸­æ–‡æ ‡é¢˜",exercises:[{name:"ä¸­æ–‡åŠ¨ä½œ",sets:"ç»„æ•°",note:"è¦ç‚¹"}]}, "diet":{breakfast:{main,alt},lunch:{main,alt},dinner:{main,alt},snack:{main,alt}}}}`;

                const res = await callDeepSeek("You are an expert fitness coach. You MUST respond in Simplified Chinese. Return JSON only.", prompt);
                if (res) {
                    try {
                        const json = JSON.parse(res.replace(/```json|```/g, '').trim());
                        const curLog = logs[today] || {};
                        saveLog(today, {
                            calories: (curLog.calories||0) + json.nutrition.cal,
                            protein: (curLog.protein||0) + json.nutrition.pro,
                            fiber: (curLog.fiber||0) + json.nutrition.fiber,
                            aiAnalysis: json.feedback,
                            // ä¿®å¤ï¼šä¸è‡ªåŠ¨å‹¾é€‰ workoutCompletedï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨ç‚¹
                        });
                        saveLog(formatDate(tmr), { generatedPlan: json.tomorrow.workout, generatedDiet: json.tomorrow.diet });
                        alert("âœ… ä»Šæ—¥ç»“ç®—å®Œæˆï¼æ˜æ—¥è®¡åˆ’å·²ç”Ÿæˆã€‚");
                        setFoodInput("");
                    } catch(e) { console.error(e); alert("AIè§£æå¤±è´¥"); }
                }
            };

            const handleFoodAnalysis = async () => {
                const res = await callDeepSeek("Nutritionist. JSON Only.", `Analyze: ${foodInput}. Return JSON: {"cal":int,"pro":int,"fiber":int}`);
                if (res) {
                    try {
                        const d = JSON.parse(res.replace(/```json|```/g, '').trim());
                        const cur = logs[formatDate(selectedDate)] || {};
                        saveLog(formatDate(selectedDate), { calories: (cur.calories||0)+d.cal, protein: (cur.protein||0)+d.pro, fiber: (cur.fiber||0)+d.fiber });
                        setFoodInput("");
                    } catch(e) { alert("è§£æå¤±è´¥"); }
                }
            };

            if (loading) return <div className="h-full flex items-center justify-center text-slate-500 animate-pulse">è¿æ¥äº‘ç«¯...</div>;
            
            return (
                <div className="h-full flex flex-col bg-[#f1f5f9] font-sans text-slate-900 overflow-hidden relative">
                    {!user ? <LoginScreen /> : (
                        <>
                            <header className="bg-white/80 p-4 shadow-sm z-30 flex justify-between items-center backdrop-blur-md absolute top-0 w-full border-b border-slate-200">
                                <div className="flex items-center gap-2">{user.photoURL && <img src={user.photoURL} className="w-8 h-8 rounded-full border border-indigo-100"/>}<div><h1 className="font-bold text-lg text-slate-800 tracking-widest">FRED.FITNESS</h1></div></div>
                                <div className="flex gap-4">
                                    {syncError && <WifiOff className="w-5 h-5 text-red-500 animate-pulse" />}
                                    <button onClick={() => signOut(auth)}><LogOut className="w-5 h-5 text-slate-400 hover:text-red-500 transition-colors"/></button>
                                    <button onClick={() => setShowSettings(!showSettings)}><Settings className="w-5 h-5 text-slate-600 hover:text-indigo-600 transition-colors"/></button>
                                </div>
                            </header>
                            <main className="flex-1 overflow-y-auto scrollbar-hide pt-16">
                                {setupMode ? <SettingsTab apiKey={apiKey} setApiKey={setApiKey} userProfile={userProfile} saveProfile={saveProfile} handleReset={handleReset} /> : 
                                showSettings ? <SettingsTab apiKey={apiKey} setApiKey={setApiKey} userProfile={userProfile} saveProfile={saveProfile} handleReset={handleReset} /> :
                                activeTab === 'log' ? <LoggerTab selectedDate={selectedDate} setSelectedDate={setSelectedDate} log={logs[formatDate(selectedDate)]||{}} saveLog={saveLog} userProfile={userProfile} dayPlan={BASE_PLAN[selectedDate.getDay()]} logs={logs} foodInput={foodInput} setFoodInput={setFoodInput} handleFoodAnalysis={handleFoodAnalysis} handleDayEndAnalysis={handleDayEndAnalysis} loading={aiLoading} /> : <HistoryTab userProfile={userProfile} logs={logs} />}
                            </main>
                            <nav className="bg-white border-t border-slate-200 flex justify-around py-3 pb-6 z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] absolute bottom-0 w-full rounded-t-3xl">
                                <button onClick={() => { setActiveTab('history'); setShowSettings(false); }} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'history' ? 'text-indigo-600 scale-105' : 'text-slate-400 hover:text-slate-600'}`}><History className="w-6 h-6" /><span className="text-[10px] font-bold mt-1">è¶‹åŠ¿</span></button>
                                <button onClick={() => { setActiveTab('log'); setShowSettings(false); }} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'log' ? 'text-indigo-600 scale-105' : 'text-slate-400 hover:text-slate-600'}`}><Activity className="w-6 h-6" /><span className="text-[10px] font-bold mt-1">æ‰“å¡</span></button>
                            </nav>
                        </>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<FredFitnessV8 />);

    </script>
</body>
</html>