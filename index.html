<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fred å¥åº·è¥å…»è®¡åˆ’ (V6.0 æ™ºèƒ½è¿›åŒ–ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 h-screen w-screen overflow-hidden flex justify-center items-center">

    <div id="root" class="w-full h-full max-w-md bg-white shadow-2xl overflow-hidden relative sm:rounded-xl sm:h-[90vh] sm:border sm:border-slate-200">
        <div class="flex h-full items-center justify-center text-slate-400 text-sm animate-pulse">
            æ­£åœ¨è¿æ¥ Fred çš„äº‘ç«¯æ•°æ®åº“...
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Activity, Utensils, Scale, Calendar, Trophy, TrendingDown, 
          Dumbbell, Droplets, BrainCircuit, ChevronRight, AlertTriangle, 
          Settings, Send, Loader2, Save, ChevronLeft, History, 
          CheckCircle2, XCircle, ArrowLeftRight, Sparkles, Flame, Apple, LogOut, Cloud, ChefHat, RefreshCw, Coffee, Leaf, Target
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot } from "firebase/firestore";

        // =================================================================
        // ğŸ”‘ Fred çš„ä¸“å± Firebase å¯†é’¥
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBXbO4WzrrHTIIZ7BH6ChSsYrGepg-ymfQ",
            authDomain: "fred-fitness.firebaseapp.com",
            projectId: "fred-fitness",
            storageBucket: "fred-fitness.firebasestorage.app",
            messagingSenderId: "740270431308",
            appId: "1:740270431308:web:245155b5d8de8addaca8e9",
            measurementId: "G-QPYZJ2WKWN"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±è´¥", e);
        }

        const DEFAULT_DEEPSEEK_KEY = "sk-72fba3190e5c4147bdd1b27fcab574dc";
        
        // --- é™æ€è®¡åˆ’åº“ (ä½œä¸ºå†·å¯åŠ¨æˆ–å…œåº•) ---
        const BASE_PLAN_LIBRARY = {
          1: { title: "èƒ¸éƒ¨ & ä¸‰å¤´è‚Œ (æ¨åŠ›)", type: "Strength", warmup: "10åˆ†é’Ÿ æ¤­åœ†æœº/å¿«èµ°", exercises: [{ name: "å¹³æ¿æ é“ƒå§æ¨", sets: "4ç»„ x 10æ¬¡" }, { name: "ä¸Šæ–œå“‘é“ƒå§æ¨", sets: "4ç»„ x 12æ¬¡" }, { name: "ç»³ç´¢ä¸‹å‹", sets: "4ç»„ x 15æ¬¡" }, { name: "æ‚¬å‚ä¸¾è…¿", sets: "4ç»„ x åŠ›ç«­" }] },
          2: { title: "èƒŒéƒ¨ & äºŒå¤´è‚Œ (æ‹‰åŠ›)", type: "Strength", warmup: "10åˆ†é’Ÿ åˆ’èˆ¹æœº", exercises: [{ name: "é«˜ä½ä¸‹æ‹‰", sets: "4ç»„ x 12æ¬¡" }, { name: "åå§¿åˆ’èˆ¹", sets: "4ç»„ x 12æ¬¡" }, { name: "æ é“ƒå¼¯ä¸¾", sets: "4ç»„ x 12æ¬¡" }, { name: "å¹³æ¿æ”¯æ’‘", sets: "4ç»„ x 60ç§’" }] },
          3: { title: "è…¿éƒ¨ & è‚©éƒ¨ (å¼ºä»£è°¢)", type: "HighIntensity", warmup: "10åˆ†é’Ÿ å•è½¦", exercises: [{ name: "æ·±è¹²/è…¿ä¸¾", sets: "5ç»„ x 10æ¬¡" }, { name: "å“‘é“ƒæ¨ä¸¾", sets: "4ç»„ x 12æ¬¡" }, { name: "ä¾§å¹³ä¸¾", sets: "5ç»„ x 15æ¬¡" }, { name: "è…¿å±ˆä¼¸", sets: "3ç»„ x 15æ¬¡" }] },
          4: { title: "æœ‰æ°§ç‡ƒè„‚ & è…¹è‚Œ", type: "Cardio", warmup: "5åˆ†é’Ÿ æ…¢è·‘", exercises: [{ name: "å·è…¹", sets: "4ç»„ x 20æ¬¡" }, { name: "ä¿„ç½—æ–¯è½¬ä½“", sets: "4ç»„ x 20æ¬¡" }, { name: "ç™»å±±è·‘", sets: "4ç»„ x 30ç§’" }, { name: "çœŸç©ºè…¹", sets: "5ç»„ x 30ç§’" }] },
          5: { title: "æ·±åº¦æ¢å¤ (REST)", type: "Rest", warmup: "æ— ", exercises: [{ name: "æ³¡æ²«è½´æ”¾æ¾", sets: "20åˆ†é’Ÿ" }, { name: "æ¸©æ°´æ¾¡", sets: "15åˆ†é’Ÿ" }] },
          6: { title: "HIIT & å…¨èº«å¾ªç¯", type: "HIIT", warmup: "5åˆ†é’Ÿ åŠ¨æ€", exercises: [{ name: "æ³¢æ¯”è·³", sets: "10ä¸ª x 5ç»„" }, { name: "å£¶é“ƒæ‘‡æ‘†", sets: "20ä¸ª x 4ç»„" }, { name: "æˆ˜ç»³", sets: "30ç§’ x 4ç»„" }] },
          0: { title: "æˆ·å¤–è€åŠ›", type: "ActiveRecovery", warmup: "åŠ¨æ€æ‹‰ä¼¸", exercises: [{ name: "æˆ·å¤–éª‘è¡Œ", sets: "60åˆ†é’Ÿ+" }, { name: "å…¨èº«æ‹‰ä¼¸", sets: "20åˆ†é’Ÿ" }] }
        };

        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- Auth Component ---
        const LoginScreen = ({ onLogin }) => {
            const [error, setError] = useState(null);
            const handleGoogleLogin = async () => {
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } catch (err) { setError("ç™»å½•å¤±è´¥: " + err.message); }
            };
            return (
                <div className="h-full flex flex-col items-center justify-center p-6 bg-slate-900 text-white animate-fade-in">
                    <Activity className="w-20 h-20 text-indigo-500 mb-6" />
                    <h1 className="text-3xl font-black mb-2">FRED<span className="text-indigo-500">.FIT</span></h1>
                    <p className="text-slate-400 mb-8 text-center text-sm">V6.0 æ™ºèƒ½è¿›åŒ–ç‰ˆ</p>
                    <button onClick={handleGoogleLogin} className="w-full max-w-xs bg-white text-slate-900 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-100 transition-colors">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" /> ä½¿ç”¨ Google è´¦å·ç™»å½•
                    </button>
                    {error && <div className="mt-4 text-red-400 text-xs bg-red-900/30 p-2 rounded">{error}</div>}
                </div>
            );
        };

        // --- Settings Component (V6.0 Update) ---
        const SettingsTab = ({ apiKey, setApiKey, userProfile, saveProfile, setSetupMode, handleReset }) => {
            const [localProfile, setLocalProfile] = useState(userProfile);

            // è‡ªåŠ¨è®¡ç®—å»ºè®®å€¼
            useEffect(() => {
                const weight = localProfile.currentWeight || 80;
                let protein = Math.round(weight * 2); // 2g/kg
                let fiber = 30; // åŸºç¡€å»ºè®®
                let calories = 2200;

                if (localProfile.goalType === 'cut') calories = 2000;
                else if (localProfile.goalType === 'bulk') calories = 2600;
                
                // åªæœ‰å½“ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨ä¿®æ”¹è¿‡æ—¶æ‰è‡ªåŠ¨è¦†ç›–(è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥æä¾›å»ºè®®å€¼)
                // setLocalProfile(prev => ({...prev, targetProtein: protein, targetCaloriesTrain: calories, targetFiber: fiber}));
            }, [localProfile.currentWeight, localProfile.goalType]);

            const handleChange = (field, val) => {
                setLocalProfile(prev => ({...prev, [field]: val}));
            };

            const handleSave = () => {
                saveProfile(localProfile);
                alert("è®¾ç½®å·²ä¿å­˜ï¼Œè®¡åˆ’å°†æ ¹æ®æ–°ç›®æ ‡è°ƒæ•´ï¼");
            };

            return (
              <div className="p-6 space-y-6 animate-fade-in bg-white h-full overflow-y-auto">
                <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Settings className="w-6 h-6" /> å®¢åˆ¶åŒ–è®¾ç½®</h2>
                
                <div className="space-y-4">
                  <div className="bg-slate-50 p-4 rounded-xl space-y-3">
                      <h3 className="font-bold text-sm text-slate-500">åŸºç¡€ä¿¡æ¯</h3>
                      <div className="grid grid-cols-2 gap-3">
                          <div><label className="text-xs font-bold text-slate-400 block mb-1">å½“å‰ä½“é‡ (kg)</label><input type="number" value={localProfile.currentWeight} onChange={e=>handleChange('currentWeight', parseFloat(e.target.value))} className="w-full bg-white border border-slate-200 rounded px-3 py-2 text-sm" /></div>
                          <div><label className="text-xs font-bold text-slate-400 block mb-1">ç›®æ ‡ä½“é‡ (kg)</label><input type="number" value={localProfile.goalWeight} onChange={e=>handleChange('goalWeight', parseFloat(e.target.value))} className="w-full bg-white border border-slate-200 rounded px-3 py-2 text-sm" /></div>
                      </div>
                  </div>

                  <div className="bg-slate-50 p-4 rounded-xl space-y-3">
                      <h3 className="font-bold text-sm text-slate-500">æ ¸å¿ƒç›®æ ‡</h3>
                      <div>
                          <label className="text-xs font-bold text-slate-400 block mb-1">è®­ç»ƒå‘¨æœŸ</label>
                          <select value={localProfile.programDuration} onChange={e=>handleChange('programDuration', e.target.value)} className="w-full bg-white border border-slate-200 rounded px-3 py-2 text-sm">
                              <option value="60">60å¤©å†²åˆº (Fred 60)</option>
                              <option value="90">90å¤©èœ•å˜ (Fred 90)</option>
                          </select>
                      </div>
                      <div>
                          <label className="text-xs font-bold text-slate-400 block mb-1">ä¸»è¦è¯‰æ±‚</label>
                          <select value={localProfile.goalType} onChange={e=>handleChange('goalType', e.target.value)} className="w-full bg-white border border-slate-200 rounded px-3 py-2 text-sm">
                              <option value="cut">æé€Ÿå‡è„‚ (è…¹è‚Œæ˜¾ç°)</option>
                              <option value="recomp">å¢è‚Œå‡è„‚ (çº¿æ¡é›•åˆ»)</option>
                              <option value="bulk">åŠ›é‡å¢è‚Œ (ç»´åº¦çªç ´)</option>
                          </select>
                      </div>
                  </div>

                  <div className="bg-slate-50 p-4 rounded-xl space-y-3">
                      <h3 className="font-bold text-sm text-slate-500">è¥å…»ç›®æ ‡ (å¯AIè‡ªåŠ¨è°ƒæ•´)</h3>
                      <div className="grid grid-cols-3 gap-2">
                          <div><label className="text-[10px] font-bold text-slate-400 block mb-1">çƒ­é‡</label><input type="number" value={localProfile.targetCaloriesTrain} onChange={e=>handleChange('targetCaloriesTrain', parseFloat(e.target.value))} className="w-full bg-white border border-slate-200 rounded px-2 py-2 text-sm text-center" /></div>
                          <div><label className="text-[10px] font-bold text-slate-400 block mb-1">è›‹ç™½è´¨</label><input type="number" value={localProfile.targetProtein} onChange={e=>handleChange('targetProtein', parseFloat(e.target.value))} className="w-full bg-white border border-slate-200 rounded px-2 py-2 text-sm text-center" /></div>
                          <div><label className="text-[10px] font-bold text-slate-400 block mb-1">è†³é£Ÿçº¤ç»´</label><input type="number" value={localProfile.targetFiber} onChange={e=>handleChange('targetFiber', parseFloat(e.target.value))} className="w-full bg-white border border-slate-200 rounded px-2 py-2 text-sm text-center" /></div>
                      </div>
                  </div>

                  <div className="bg-slate-50 p-4 rounded-xl space-y-3">
                      <h3 className="font-bold text-sm text-slate-500">ç³»ç»Ÿ</h3>
                      <div><label className="text-xs font-bold text-slate-400 block mb-1">DeepSeek Key</label><input type="password" value={apiKey} onChange={e => { setApiKey(e.target.value); localStorage.setItem('fred_deepseek_key', e.target.value); }} className="w-full bg-white border border-slate-200 rounded px-3 py-2 text-sm font-mono" /></div>
                  </div>

                  <button onClick={handleSave} className="w-full py-4 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-200">ä¿å­˜è®¾ç½®</button>
                  
                  <div className="pt-4 border-t border-slate-100">
                      <button onClick={handleReset} className="w-full py-4 bg-red-50 text-red-600 rounded-xl text-sm font-bold border border-red-100 flex items-center justify-center gap-2"><RefreshCw className="w-4 h-4"/> é‡ç½®æ‰€æœ‰è¿›åº¦</button>
                  </div>
                </div>
              </div>
            );
        };

        const HistoryTab = ({ userProfile, logs }) => {
          // ... (HistoryTab ä»£ç ä¿æŒä¸å˜ï¼Œä¸ºèŠ‚çœç©ºé—´çœç•¥ï¼Œé€»è¾‘ä¸ V5.9 ä¸€è‡´) ...
          // åœ¨å®é™…éƒ¨ç½²æ—¶ï¼Œè¯·ä¿ç•™ V5.9 çš„ HistoryTab å®Œæ•´ä»£ç 
          // è¿™é‡Œç®€å•æ”¾ä¸€ä¸ªå ä½ï¼Œç¡®ä¿ä¸æŠ¥é”™ï¼Œå®é™…ä½¿ç”¨è¯·å¤åˆ¶ V5.9 çš„ HistoryTab
          const historyData = useMemo(() => {
            const days = []; const today = new Date();
            for (let i = 13; i >= 0; i--) {
                const d = new Date(); d.setDate(today.getDate() - i);
                const dateStr = formatDate(d); let log = logs[dateStr];
                if (!log) log = { isVirtual: true, weight: 0, calories: 0, protein: 0, workoutCompleted: false };
                days.push({ date: dateStr, ...log });
            }
            return days;
          }, [logs]);
          
          return (
             <div className="p-4 space-y-4 pb-24">
                <div className="bg-white p-5 rounded-2xl shadow-sm text-center"><h3 className="font-bold text-slate-500">è¶‹åŠ¿åˆ†ææ¨¡å—</h3><p className="text-xs text-slate-400">è¯·é›†æˆ V5.9 çš„å®Œæ•´ HistoryTab ä»£ç ä»¥è·å¾—æœ€ä½³å›¾è¡¨ä½“éªŒ</p></div>
             </div>
          );
        };

        // --- Logger Tab (V6.0 æ ¸å¿ƒ) ---
        const LoggerTab = ({ 
          selectedDate, setSelectedDate, log, saveLog, userProfile, logs,
          foodInput, setFoodInput, handleFoodAnalysis, loading, handleDayEndAnalysis, isSyncing, syncError
        }) => {
          const isToday = formatDate(selectedDate) === formatDate(new Date());
          
          // æ™ºèƒ½è®¡åˆ’é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨ AI ç”Ÿæˆçš„è®¡åˆ’ (log.generatedPlan)ï¼Œå¦åˆ™å›é€€åˆ°åŸºç¡€åº“
          const activePlan = log.generatedPlan || BASE_PLAN_LIBRARY[selectedDate.getDay()];
          const isGenerated = !!log.generatedPlan;

          // ç”Ÿæˆä»Šæ—¥è®¡åˆ’ (æ—©å®‰æ¨¡å¼)
          const generateTodayPlan = () => {
              handleDayEndAnalysis(true); // true è¡¨ç¤ºæ˜¯â€œç”Ÿæˆè®¡åˆ’â€è€Œéâ€œç»“æ¡ˆâ€
          };

          return (
            <div className="space-y-4 animate-fade-in pb-24 p-4">
              {/* æ—¥æœŸå¯¼èˆª */}
              <div className="flex items-center justify-between bg-white p-3 rounded-2xl shadow-sm sticky top-0 z-20 border border-slate-100 backdrop-blur-md bg-opacity-90">
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() - 1); setSelectedDate(d); }} className="p-2 bg-slate-50 rounded-full text-slate-600 hover:bg-slate-100"><ChevronLeft className="w-5 h-5" /></button>
                <div className="text-center">
                  <div className="font-bold text-slate-800 flex items-center justify-center gap-2 text-lg">
                    {isToday && <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>}
                    {selectedDate.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}
                  </div>
                  <div className="text-[10px] text-indigo-500 font-bold uppercase mt-0.5 tracking-wider flex items-center justify-center gap-1">
                      {isGenerated && <Sparkles className="w-3 h-3"/>}
                      {activePlan.title}
                  </div>
                </div>
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() + 1); setSelectedDate(d); }} className="p-2 bg-slate-50 rounded-full text-slate-600 hover:bg-slate-100"><ChevronRight className="w-5 h-5" /></button>
              </div>

              {/* è®­ç»ƒè®¡åˆ’å¡ç‰‡ */}
              <div className={`bg-white p-5 rounded-3xl shadow-sm border-l-4 transition-all ${log.workoutCompleted ? 'border-green-500 shadow-green-100' : (isGenerated ? 'border-purple-500' : 'border-indigo-500')}`}>
                <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-slate-900 flex items-center gap-2">
                      <Dumbbell className={`w-5 h-5 ${isGenerated ? 'text-purple-500' : 'text-indigo-500'}`} /> 
                      {isGenerated ? "AI å®šåˆ¶è®­ç»ƒ" : "ä»Šæ—¥è®­ç»ƒ"}
                  </h3>
                  {!isGenerated && isToday && (
                      <button onClick={generateTodayPlan} disabled={loading} className="text-[10px] bg-purple-50 text-purple-600 px-2 py-1 rounded-full border border-purple-100 flex items-center gap-1">
                          {loading ? <Loader2 className="w-3 h-3 animate-spin"/> : <Sparkles className="w-3 h-3"/>} AI å®šåˆ¶ä»Šæ—¥
                      </button>
                  )}
                </div>
                
                <div className="space-y-4">
                  {activePlan.exercises.map((ex, i) => (
                      <div key={i} className="flex justify-between items-start border-b border-slate-50 pb-3 last:border-0">
                        <div className="flex-1">
                          <div className="font-bold text-sm text-slate-700">{ex.name}</div>
                          <div className="text-xs text-slate-400 font-mono mt-1">{ex.sets} {ex.note && `Â· ${ex.note}`}</div>
                        </div>
                        <div className="w-4 h-4 rounded-full border border-slate-300 mt-1"></div>
                      </div>
                  ))}
                </div>
                
                {/* æ¯æ—¥æ•™ç»ƒå»ºè®® (AIç”Ÿæˆçš„) */}
                {log.coachAdvice && (
                    <div className="mt-4 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div className="flex items-center gap-2 mb-1 text-xs font-bold text-slate-600"><BrainCircuit className="w-3 h-3"/> æ•™ç»ƒæŒ‡å¯¼</div>
                        <div className="text-xs text-slate-500 leading-relaxed">{log.coachAdvice}</div>
                    </div>
                )}
              </div>

              {/* é¥®é£Ÿä¸æ•°æ®å½•å…¥ (æ–°å¢çº¤ç»´) */}
              <div className="bg-white p-5 rounded-3xl shadow-sm">
                <div className="flex items-center gap-2 mb-4 font-bold text-slate-800"><Utensils className="w-5 h-5 text-indigo-500" /> é¥®é£Ÿä¸èº«ä½“æ•°æ®</div>
                
                <div className="bg-indigo-50 p-3 rounded-2xl mb-6 border border-indigo-100 relative">
                  <textarea value={foodInput} onChange={e => setFoodInput(e.target.value)} placeholder="è®°å½•å…¨å¤©é¥®é£Ÿï¼šæ—©é¥­åƒäº†...åˆé¥­åƒäº†..." className="w-full bg-white p-3 text-sm rounded-xl outline-none border border-transparent focus:border-indigo-300 h-24 resize-none mb-2 placeholder-indigo-200 text-indigo-900" />
                  <button onClick={handleFoodAnalysis} disabled={loading} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-xl text-xs font-bold flex justify-center items-center gap-1.5 transition-colors shadow-lg shadow-indigo-200">
                    {loading ? <Loader2 className="w-3.5 h-3.5 animate-spin" /> : <Sparkles className="w-3.5 h-3.5" />} AI åˆ†æè¥å…»æˆåˆ†
                  </button>
                </div>

                <div className="grid grid-cols-3 gap-3 mb-6">
                  <div className="bg-slate-50 p-3 rounded-2xl text-center">
                    <div className="text-[10px] font-bold text-slate-400 uppercase mb-1">è›‹ç™½è´¨</div>
                    <div className="flex justify-center items-end gap-1">
                      <input type="number" value={log.protein || ''} onChange={e => saveLog(formatDate(selectedDate), { protein: parseFloat(e.target.value) || 0 })} className="w-12 bg-transparent font-mono font-bold text-lg outline-none text-slate-800 text-center" placeholder="0" />
                      <span className="text-[8px] text-slate-400 mb-1">/{userProfile.targetProtein}</span>
                    </div>
                  </div>
                  <div className="bg-slate-50 p-3 rounded-2xl text-center">
                    <div className="text-[10px] font-bold text-slate-400 uppercase mb-1">çƒ­é‡</div>
                    <div className="flex justify-center items-end gap-1">
                      <input type="number" value={log.calories || ''} onChange={e => saveLog(formatDate(selectedDate), { calories: parseFloat(e.target.value) || 0 })} className="w-14 bg-transparent font-mono font-bold text-lg outline-none text-slate-800 text-center" placeholder="0" />
                      <span className="text-[8px] text-slate-400 mb-1">/{userProfile.targetCaloriesTrain}</span>
                    </div>
                  </div>
                  <div className="bg-slate-50 p-3 rounded-2xl text-center border border-green-100">
                    <div className="text-[10px] font-bold text-green-600 uppercase mb-1 flex justify-center items-center gap-1"><Leaf className="w-3 h-3"/> çº¤ç»´</div>
                    <div className="flex justify-center items-end gap-1">
                      <input type="number" value={log.fiber || ''} onChange={e => saveLog(formatDate(selectedDate), { fiber: parseFloat(e.target.value) || 0 })} className="w-12 bg-transparent font-mono font-bold text-lg outline-none text-green-700 text-center" placeholder="0" />
                      <span className="text-[8px] text-green-400 mb-1">/{userProfile.targetFiber}</span>
                    </div>
                  </div>
                </div>

                <div className="border-t border-slate-100 pt-4 px-2 flex justify-between items-center">
                    <span className="text-sm font-bold text-slate-700 flex items-center gap-2"><Scale className="w-4 h-4 text-indigo-400"/> ä»Šæ—¥æ™¨é‡</span>
                    <div className="flex items-center gap-1 bg-slate-50 rounded-lg p-1 pr-3">
                      <input type="number" step="0.1" value={log.weight || ''} onChange={e => saveLog(formatDate(selectedDate), { weight: parseFloat(e.target.value) || 0 })} className="w-16 bg-transparent p-1 text-center font-bold text-slate-800 outline-none" placeholder="0.0" />
                      <span className="text-xs text-slate-400 font-bold">kg</span>
                    </div>
                </div>
              </div>

              {/* åº•éƒ¨æ“ä½œåŒºï¼šæš‚å­˜ vs ç»“æ¡ˆ */}
              <div className="grid grid-cols-3 gap-3 pt-2">
                  <button onClick={()=>saveLog(formatDate(selectedDate), {})} className="col-span-1 py-3 bg-slate-100 text-slate-500 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-slate-200">
                      <Save className="w-4 h-4"/> æš‚å­˜è¿›åº¦
                  </button>
                  <button onClick={()=>handleDayEndAnalysis(false)} disabled={loading} className="col-span-2 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl text-xs font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-200 hover:scale-[1.02] transition-transform active:scale-95">
                      {loading ? <Loader2 className="w-4 h-4 animate-spin"/> : <Target className="w-4 h-4"/>} 
                      {loading ? "AI æ€è€ƒä¸­..." : "ç»“æŸæ‰“å¡ & AI å…¨é‡åˆ†æ"}
                  </button>
              </div>
              <p className="text-[10px] text-center text-slate-300">ç‚¹å‡»â€œAIåˆ†æâ€å°†é”å®šä»Šæ—¥æ•°æ®ï¼Œå¹¶ç”Ÿæˆæ˜æ—¥è®¡åˆ’</p>
            </div>
          );
        };

        // --- Main App Logic ---
        function FredFitnessV6() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // æ•°æ®æ¨¡å‹å‡çº§ï¼šå¢åŠ äº† targetFiber, programDuration, goalType
            const [userProfile, setUserProfile] = useState({ 
                name: "Fred", currentWeight: 80.0, startWeight: 80.0, goalWeight: 74.0, startDate: formatDate(new Date()), 
                programDuration: "60", goalType: "cut",
                targetProtein: 160, targetCaloriesTrain: 2200, targetFiber: 30 
            });
            const [logs, setLogs] = useState({});
            
            const [activeTab, setActiveTab] = useState('log');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [setupMode, setSetupMode] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);
            const [foodInput, setFoodInput] = useState("");
            const [apiKey, setApiKey] = useState(localStorage.getItem('fred_deepseek_key') || DEFAULT_DEEPSEEK_KEY);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                    if (currentUser) {
                        const localData = localStorage.getItem('fred_logs_v6_backup');
                        if (localData) try { setLogs(JSON.parse(localData)); } catch(e) {}
                        
                        const docRef = doc(db, "users", currentUser.uid);
                        onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (data.profile) setUserProfile(data.profile);
                                if (data.logs) {
                                    setLogs(data.logs);
                                    localStorage.setItem('fred_logs_v6_backup', JSON.stringify(data.logs));
                                }
                                setSetupMode(false);
                            } else { setSetupMode(true); }
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            const saveToCloud = async (newProfile, newLogs) => {
                if (newLogs) localStorage.setItem('fred_logs_v6_backup', JSON.stringify(newLogs));
                if (!user) return;
                try { 
                    await setDoc(doc(db, "users", user.uid), { profile: newProfile || userProfile, logs: newLogs || logs }, { merge: true }); 
                } catch (e) { console.error("åŒæ­¥å¤±è´¥", e); }
            };
            const saveProfile = (p) => { setUserProfile(p); saveToCloud(p, null); setSetupMode(false); };
            const saveLog = (d, data) => { 
                const newLogs = { ...logs, [d]: { ...logs[d], ...data, date: d } }; 
                setLogs(newLogs); 
                saveToCloud(null, newLogs); 
            };

            const callDeepSeek = async (systemPrompt, userPrompt) => {
                const key = apiKey || DEFAULT_DEEPSEEK_KEY;
                if (!key) return alert("è¯·é…ç½® API Key");
                setAiLoading(true);
                try {
                    const res = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                        body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], temperature: 0.7 })
                    });
                    const data = await res.json();
                    setAiLoading(false);
                    return data.choices[0].message.content;
                } catch (e) { setAiLoading(false); alert("AI è¯·æ±‚å¤±è´¥"); return null; }
            };

            // V6.0 æ ¸å¿ƒï¼šAI ç»¼åˆåˆ†æ
            const handleDayEndAnalysis = async (isMorningMode = false) => {
                const dateStr = formatDate(selectedDate);
                
                // 1. å‡†å¤‡è¿‡å»7å¤©çš„æ•°æ®ä¸Šä¸‹æ–‡
                const historyContext = [];
                for(let i=7; i>=1; i--) {
                    const d = new Date(selectedDate); d.setDate(d.getDate()-i);
                    const ds = formatDate(d);
                    if(logs[ds]) historyContext.push(`${ds}: æ‘„å…¥${logs[ds].calories}kcal, è›‹ç™½${logs[ds].protein}g, è®­ç»ƒ${logs[ds].workoutCompleted?'å®Œæˆ':'æœªåš'}`);
                }
                const contextStr = historyContext.join("\n");

                let prompt = "";
                let systemPrompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä½“èƒ½è®­ç»ƒå¸ˆå’Œè¥å…»ä¸“å®¶Fred Coachã€‚";

                if (isMorningMode) {
                    // æ—©å®‰æ¨¡å¼ï¼šåªç”Ÿæˆä»Šæ—¥è®¡åˆ’
                    prompt = `ä»Šå¤©æ˜¯ ${dateStr}ã€‚æˆ‘çš„ç›®æ ‡æ˜¯ ${userProfile.goalType}ã€‚
                    è¿‡å»7å¤©æƒ…å†µï¼š\n${contextStr}
                    è¯·æ ¹æ®æˆ‘çš„çŠ¶æ€ï¼Œä¸ºæˆ‘ç”Ÿæˆ **ä»Šå¤©** çš„è¯¦ç»†è®­ç»ƒè®¡åˆ’ï¼ˆåŠ¨ä½œã€ç»„æ•°ï¼‰å’Œé¥®é£Ÿå»ºè®®ã€‚
                    è¯·ç›´æ¥è¿”å› JSON æ ¼å¼ï¼š
                    {
                        "planTitle": "ä»Šæ—¥ä¸»é¢˜ (å¦‚ï¼šèƒ¸è‚Œå¼ºåŒ–)", 
                        "exercises": [{ "name": "åŠ¨ä½œå", "sets": "ç»„æ•°", "note": "è¦ç‚¹" }],
                        "coachAdvice": "ç»™æˆ‘çš„ä»Šæ—¥å¯„è¯­"
                    }`;
                } else {
                    // æ™šå®‰æ¨¡å¼ï¼šåˆ†æä»Šæ—¥ + ç”Ÿæˆæ˜æ—¥
                    const currentLog = logs[dateStr] || {};
                    prompt = `ä»Šå¤©æ˜¯ ${dateStr}ã€‚æˆ‘è®°å½•äº†ï¼š${foodInput}ã€‚
                    æ•°æ®ï¼šçƒ­é‡ ${currentLog.calories}, è›‹ç™½ ${currentLog.protein}, çº¤ç»´ ${currentLog.fiber}, è®­ç»ƒ ${currentLog.workoutCompleted}ã€‚
                    è¿‡å»7å¤©æƒ…å†µï¼š\n${contextStr}
                    ä»»åŠ¡ï¼š
                    1. ç‚¹è¯„æˆ‘ä»Šå¤©çš„è¡¨ç°ã€‚
                    2. æ ¹æ®ä»Šå¤©çš„æƒ…å†µï¼Œä¸º **æ˜å¤©** åˆ¶å®šè®¡åˆ’ã€‚
                    è¯·ç›´æ¥è¿”å› JSON æ ¼å¼ï¼š
                    {
                        "todayFeedback": "é’ˆå¯¹ä»Šå¤©çš„çŠ€åˆ©ç‚¹è¯„",
                        "tomorrowPlan": {
                            "title": "æ˜æ—¥ä¸»é¢˜",
                            "exercises": [{ "name": "åŠ¨ä½œå", "sets": "ç»„æ•°" }]
                        }
                    }`;
                }

                const res = await callDeepSeek(systemPrompt + " åªè¿”å›çº¯JSONï¼Œæ— Markdownã€‚", prompt);
                if (res) {
                    try {
                        const cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
                        const data = JSON.parse(cleanJson);
                        
                        if (isMorningMode) {
                            // ä¿å­˜ä»Šæ—¥è®¡åˆ’
                            saveLog(dateStr, { 
                                generatedPlan: { title: data.planTitle, exercises: data.exercises },
                                coachAdvice: data.coachAdvice
                            });
                        } else {
                            // ä¿å­˜ä»Šæ—¥è¯„ä»· + æ˜æ—¥è®¡åˆ’
                            saveLog(dateStr, { aiAnalysis: data.todayFeedback });
                            
                            const tmr = new Date(selectedDate); tmr.setDate(tmr.getDate()+1);
                            const tmrStr = formatDate(tmr);
                            saveLog(tmrStr, { 
                                generatedPlan: { title: data.tomorrowPlan.title, exercises: data.tomorrowPlan.exercises },
                                coachAdvice: "ï¼ˆåŸºäºæ˜¨æ—¥åˆ†æç”Ÿæˆçš„è®¡åˆ’ï¼‰"
                            });
                            alert("ä»Šæ—¥æ‰“å¡å®Œæˆï¼æ˜å¤©çš„è®¡åˆ’å·²è‡ªåŠ¨ç”Ÿæˆã€‚");
                        }
                    } catch (e) { console.error(e); alert("AI è§£æå¤±è´¥ï¼Œè¯·é‡è¯•"); }
                }
            };

            // AI é¥®é£Ÿè¯†åˆ« (åŒ…å«çº¤ç»´)
            const handleFoodAnalysis = async () => {
                if (!foodInput.trim()) return;
                const prompt = `åˆ†æé£Ÿç‰©ï¼š${foodInput}ã€‚è¿”å›JSONï¼š{"calories":int, "protein":int, "fiber":int}`;
                const res = await callDeepSeek("è¥å…»å¸ˆï¼Œåªå›JSON", prompt);
                if (res) {
                    try {
                        const data = JSON.parse(res.replace(/```json|```/g, '').trim());
                        const current = logs[formatDate(selectedDate)] || {};
                        saveLog(formatDate(selectedDate), { 
                            calories: (current.calories||0) + data.calories, 
                            protein: (current.protein||0) + data.protein,
                            fiber: (current.fiber||0) + data.fiber 
                        });
                        setFoodInput("");
                    } catch(e) { alert("è§£æå¤±è´¥"); }
                }
            };

            if (loading) return <div className="h-full flex items-center justify-center text-slate-500 animate-pulse">è¿æ¥äº‘ç«¯...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="h-full flex flex-col bg-slate-50 font-sans text-slate-900 overflow-hidden relative">
                    <header className="bg-white p-4 shadow-sm z-30 flex justify-between items-center backdrop-blur-md bg-opacity-80 absolute top-0 w-full">
                        <div className="flex items-center gap-2">{user.photoURL && <img src={user.photoURL} className="w-8 h-8 rounded-full border border-indigo-200"/>}<div><h1 className="font-black text-lg italic text-slate-800 tracking-tighter">FRED<span className="text-indigo-600">.AI</span></h1></div></div>
                        <div className="flex gap-3"><button onClick={() => signOut(auth)}><LogOut className="w-5 h-5 text-slate-400"/></button><button onClick={() => setShowSettings(!showSettings)}><Settings className="w-5 h-5 text-indigo-600"/></button></div>
                    </header>
                    <main className="flex-1 overflow-y-auto scrollbar-hide pt-16">
                        {setupMode ? <SettingsTab apiKey={apiKey} setApiKey={setApiKey} userProfile={userProfile} saveProfile={saveProfile} setSetupMode={setSetupMode} handleReset={()=>{}} /> : 
                        showSettings ? <SettingsTab apiKey={apiKey} setApiKey={setApiKey} userProfile={userProfile} saveProfile={saveProfile} setSetupMode={setSetupMode} handleReset={()=>{}} /> :
                        activeTab === 'log' ? <LoggerTab selectedDate={selectedDate} setSelectedDate={setSelectedDate} log={logs[formatDate(selectedDate)]||{}} saveLog={saveLog} userProfile={userProfile} logs={logs} foodInput={foodInput} setFoodInput={setFoodInput} handleFoodAnalysis={handleFoodAnalysis} handleDayEndAnalysis={handleDayEndAnalysis} loading={aiLoading} /> : <HistoryTab userProfile={userProfile} logs={logs} />}
                    </main>
                    <nav className="bg-white border-t border-slate-100 flex justify-around py-3 pb-6 z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] absolute bottom-0 w-full rounded-t-3xl">
                        <button onClick={() => { setActiveTab('history'); setShowSettings(false); }} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'history' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'}`}><History className="w-6 h-6" /><span className="text-[10px] font-bold mt-1">è¶‹åŠ¿</span></button>
                        <button onClick={() => { setActiveTab('log'); setShowSettings(false); }} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'log' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'}`}><Activity className="w-6 h-6" /><span className="text-[10px] font-bold mt-1">æ‰“å¡</span></button>
                    </nav>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<FredFitnessV6 />);

    </script>
</body>
</html>