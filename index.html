<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fred å¥åº·è¥å…»è®¡åˆ’ (V7.0 One-Click AI)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { 
            font-family: "Segoe UI", "SF Pro Display", -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
            background-color: #f8f9fa;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 h-screen w-screen overflow-hidden flex justify-center items-center">

    <div id="root" class="w-full h-full max-w-md bg-white/50 shadow-2xl overflow-hidden relative sm:rounded-2xl sm:h-[90vh] sm:border sm:border-white/50">
        <div class="flex h-full items-center justify-center text-slate-400 text-sm animate-pulse">
            <div class="flex flex-col items-center gap-3">
                <div class="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                <span>Fred.AI V7.0 Loading...</span>
            </div>
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Activity, Utensils, Scale, Calendar, Trophy, TrendingDown, 
          Dumbbell, Droplets, BrainCircuit, ChevronRight, AlertTriangle, 
          Settings, Send, Loader2, Save, ChevronLeft, History, 
          CheckCircle2, XCircle, ArrowLeftRight, Sparkles, Flame, Apple, LogOut, Cloud, ChefHat, RefreshCw, Coffee, Target
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot } from "firebase/firestore";

        // =================================================================
        // ğŸ”‘ Fred çš„ä¸“å± Firebase å¯†é’¥
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBXbO4WzrrHTIIZ7BH6ChSsYrGepg-ymfQ",
            authDomain: "fred-fitness.firebaseapp.com",
            projectId: "fred-fitness",
            storageBucket: "fred-fitness.firebasestorage.app",
            messagingSenderId: "740270431308",
            appId: "1:740270431308:web:245155b5d8de8addaca8e9",
            measurementId: "G-QPYZJ2WKWN"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±è´¥", e);
        }

        const DEFAULT_DEEPSEEK_KEY = "sk-72fba3190e5c4147bdd1b27fcab574dc";
        
        // --- é™æ€å…œåº•åº“ ---
        const BASE_PLAN_LIBRARY = {
          1: { title: "èƒ¸éƒ¨ & ä¸‰å¤´è‚Œ", type: "Strength", exercises: [{ name: "å¹³æ¿æ é“ƒå§æ¨", sets: "4ç»„ x 10æ¬¡" }, { name: "ä¸Šæ–œå“‘é“ƒå§æ¨", sets: "4ç»„ x 12æ¬¡" }, { name: "ç»³ç´¢ä¸‹å‹", sets: "4ç»„ x 15æ¬¡" }, { name: "æ‚¬å‚ä¸¾è…¿", sets: "4ç»„ x åŠ›ç«­" }] },
          2: { title: "èƒŒéƒ¨ & äºŒå¤´è‚Œ", type: "Strength", exercises: [{ name: "é«˜ä½ä¸‹æ‹‰", sets: "4ç»„ x 12æ¬¡" }, { name: "åå§¿åˆ’èˆ¹", sets: "4ç»„ x 12æ¬¡" }, { name: "æ é“ƒå¼¯ä¸¾", sets: "4ç»„ x 12æ¬¡" }, { name: "å¹³æ¿æ”¯æ’‘", sets: "4ç»„ x 60ç§’" }] },
          3: { title: "è…¿éƒ¨ & è‚©éƒ¨", type: "HighIntensity", exercises: [{ name: "æ·±è¹²/è…¿ä¸¾", sets: "5ç»„ x 10æ¬¡" }, { name: "å“‘é“ƒæ¨ä¸¾", sets: "4ç»„ x 12æ¬¡" }, { name: "ä¾§å¹³ä¸¾", sets: "5ç»„ x 15æ¬¡" }, { name: "è…¿å±ˆä¼¸", sets: "3ç»„ x 15æ¬¡" }] },
          4: { title: "æœ‰æ°§ç‡ƒè„‚ & è…¹è‚Œ", type: "Cardio", exercises: [{ name: "å·è…¹", sets: "4ç»„ x 20æ¬¡" }, { name: "ä¿„ç½—æ–¯è½¬ä½“", sets: "4ç»„ x 20æ¬¡" }, { name: "ç™»å±±è·‘", sets: "4ç»„ x 30ç§’" }, { name: "çœŸç©ºè…¹", sets: "5ç»„ x 30ç§’" }] },
          5: { title: "æ·±åº¦æ¢å¤", type: "Rest", exercises: [{ name: "æ³¡æ²«è½´æ”¾æ¾", sets: "20åˆ†é’Ÿ" }, { name: "æ¸©æ°´æ¾¡", sets: "15åˆ†é’Ÿ" }] },
          6: { title: "HIIT", type: "HIIT", exercises: [{ name: "æ³¢æ¯”è·³", sets: "10ä¸ª x 5ç»„" }, { name: "å£¶é“ƒæ‘‡æ‘†", sets: "20ä¸ª x 4ç»„" }, { name: "æˆ˜ç»³", sets: "30ç§’ x 4ç»„" }] },
          0: { title: "æˆ·å¤–è€åŠ›", type: "ActiveRecovery", exercises: [{ name: "æˆ·å¤–éª‘è¡Œ", sets: "60åˆ†é’Ÿ+" }, { name: "å…¨èº«æ‹‰ä¼¸", sets: "20åˆ†é’Ÿ" }] }
        };

        const DEFAULT_MEALS = {
            breakfast: { main: "å…¨éº¦é¢åŒ… + é¸¡è›‹ + é»‘å’–å•¡", alt: "ç‡•éº¦ç‰‡ + è›‹ç™½ç²‰" },
            lunch: { main: "é¸¡èƒ¸è‚‰ + ç³™ç±³é¥­ + è¥¿å…°èŠ±", alt: "ç˜¦ç‰›è‚‰ + çº¢è–¯ + è”¬èœ" },
            dinner: { main: "é±¼è‚‰/æµ·é²œ + å¤§ä»½è”¬èœ", alt: "è±†è…ç˜¦è‚‰æ±¤ + å‡‰æ‹Œèœ" },
            snack: { main: "é¦™è•‰ / è›‹ç™½ç²‰", alt: "æ— ç³–é…¸å¥¶" }
        };

        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- Auth ---
        const LoginScreen = ({ onLogin }) => {
            const handleGoogleLogin = async () => {
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } catch (err) { alert("ç™»å½•å¤±è´¥: " + err.message); }
            };
            return (
                <div className="h-full flex flex-col items-center justify-center p-6 bg-slate-900 text-white animate-fade-in">
                    <Activity className="w-20 h-20 text-indigo-500 mb-6" />
                    <h1 className="text-3xl font-bold tracking-tight mb-2">FRED<span className="text-indigo-500">.FIT</span></h1>
                    <p className="text-slate-400 mb-8 text-center text-sm">V7.0 æ™ºèƒ½é—­ç¯ç‰ˆ</p>
                    <button onClick={handleGoogleLogin} className="w-full max-w-xs bg-white text-slate-900 font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-100 transition-all shadow-lg active:scale-95">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" /> ä½¿ç”¨ Google è´¦å·ç™»å½•
                    </button>
                </div>
            );
        };

        // --- Settings (å¸¦é‡ç½®) ---
        const SettingsTab = ({ apiKey, setApiKey, userProfile, saveProfile, handleReset }) => {
            const [localProfile, setLocalProfile] = useState(userProfile);
            const handleChange = (field, val) => setLocalProfile(prev => ({...prev, [field]: val}));
            
            return (
              <div className="p-6 space-y-6 animate-fade-in bg-[#f8f9fa] h-full overflow-y-auto">
                <h2 className="text-2xl font-semibold flex items-center gap-2 text-slate-800 tracking-tight">è®¾ç½®</h2>
                <div className="space-y-6">
                  <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                      <div className="flex items-center gap-2 text-slate-700 font-medium"><Target className="w-5 h-5 text-indigo-500"/> <span>æ ¸å¿ƒæŒ‡æ ‡ (ç”¨äºè¶‹åŠ¿å›¾)</span></div>
                      <div className="grid grid-cols-2 gap-4">
                          <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">åˆå§‹ä½“é‡</label><input type="number" value={localProfile.startWeight} onChange={e=>handleChange('startWeight', parseFloat(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm font-bold text-slate-700" /></div>
                          <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">ç›®æ ‡ä½“é‡</label><input type="number" value={localProfile.goalWeight} onChange={e=>handleChange('goalWeight', parseFloat(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm font-bold text-slate-700" /></div>
                      </div>
                  </div>
                  <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                      <div className="flex items-center gap-2 text-slate-700 font-medium"><BrainCircuit className="w-5 h-5 text-indigo-500"/> <span>AI é…ç½®</span></div>
                      <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">DeepSeek Key</label><input type="password" value={apiKey} onChange={e => { setApiKey(e.target.value); localStorage.setItem('fred_deepseek_key', e.target.value); }} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm font-mono text-slate-600" placeholder="sk-..." /></div>
                  </div>
                  <button onClick={() => {saveProfile(localProfile); alert("è®¾ç½®å·²ä¿å­˜")}} className="w-full py-4 bg-slate-900 text-white rounded-xl text-sm font-bold shadow-md hover:bg-slate-800 transition-all">ä¿å­˜è®¾ç½®</button>
                  
                  {/* é‡ç½®åŒºåŸŸ */}
                  <div className="pt-8 mt-4 border-t border-slate-200">
                      <button onClick={handleReset} className="w-full py-4 bg-red-50 text-red-600 border border-red-200 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-red-100 transition-colors">
                          <RefreshCw className="w-4 h-4"/> é‡å¯è®­ç»ƒè®¡åˆ’ (æ¸…ç©ºæ‰€æœ‰)
                      </button>
                  </div>
                </div>
              </div>
            );
        };

        // --- History Tab (ä¿®å¤è¶‹åŠ¿å›¾æ¯”ä¾‹ + ç›®æ ‡çº¿) ---
        const HistoryTab = ({ userProfile, logs }) => {
          const historyData = useMemo(() => {
            const days = []; const today = new Date();
            for (let i = 13; i >= 0; i--) {
                const d = new Date(); d.setDate(today.getDate() - i);
                const dateStr = formatDate(d); let log = logs[dateStr];
                if (!log) log = { isVirtual: true, weight: 0, calories: 0, protein: 0, workoutCompleted: false };
                days.push({ date: dateStr, ...log });
            }
            return days;
          }, [logs]);

          const currentWeight = historyData.slice().reverse().find(d => d.weight > 0)?.weight || userProfile.startWeight;
          const progress = (userProfile.startWeight - currentWeight).toFixed(1);
          
          // --- è¶‹åŠ¿å›¾é€»è¾‘ä¿®å¤ V7.0 ---
          let plotData = [...historyData];
          // æå–æ‰€æœ‰æœ‰æ•ˆä½“é‡ç‚¹
          const validWeights = plotData.filter(d => d.weight > 0).map(d => d.weight);
          // å…³é”®ï¼šå°† ç›®æ ‡ä½“é‡ å’Œ åˆå§‹ä½“é‡ åŠ å…¥æå€¼è®¡ç®—ï¼Œé”æ­»åæ ‡ç³»
          // è¿™æ ·å³ä½¿åªæ³¢åŠ¨0.1kgï¼Œä¹Ÿä¸ä¼šæ’‘æ»¡å…¨å±
          const allRefPoints = [...validWeights, userProfile.goalWeight, userProfile.startWeight];
          const minW = Math.min(...allRefPoints) - 1; 
          const maxW = Math.max(...allRefPoints) + 1;
          const range = maxW - minW || 1;
          
          // è®¡ç®—ç›®æ ‡çº¿çš„ Y åæ ‡
          const goalY = 100 - ((userProfile.goalWeight - minW) / range) * 100;

          const points = plotData.map((day, index) => {
              if (!day.weight || day.weight <= 0) return null;
              const x = (index / 13) * 100; 
              const y = 100 - ((day.weight - minW) / range) * 100;
              return { x, y, val: day.weight };
          }).filter(p => p !== null);

          const linePath = points.map(p => `${p.x},${p.y}`).join(" ");
          let areaPath = "";
          if (points.length > 0) {
              const first = points[0]; const last = points[points.length - 1];
              areaPath = `${linePath} L${last.x},100 L${first.x},100 Z`;
          }

          const calculateScore = (day) => {
              if (day.isVirtual) return 0;
              let score = 0;
              if (day.workoutCompleted) score += 40;
              if (day.protein >= (userProfile.targetProtein || 160) * 0.8) score += 30;
              if (day.calories > 0) score += 30; // åªè¦è®°å½•äº†çƒ­é‡å°±ç®—æ€åº¦åˆ†
              return Math.min(100, Math.round(score));
          };

          return (
            <div className="space-y-6 animate-fade-in pb-24 p-4 bg-[#f8f9fa] h-full overflow-y-auto">
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                <div className="relative z-10">
                    <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">å½“å‰ä½“é‡</h2>
                    <div className="flex items-baseline gap-2 mb-4">
                        <span className="text-5xl font-bold text-slate-800 tracking-tighter">{currentWeight}</span>
                        <span className="text-lg text-slate-500">kg</span>
                        <span className="ml-auto text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md">ç›®æ ‡ {userProfile.goalWeight}</span>
                    </div>
                </div>
              </div>

              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h2 className="font-bold text-slate-800 mb-6 flex items-center gap-2"><Activity className="w-5 h-5 text-indigo-500" /> ä½“é‡è¶‹åŠ¿ (14å¤©)</h2>
                <div className="h-48 w-full relative px-2 select-none">
                    {/* ä¿®å¤ï¼šç›®æ ‡çº¿ - é•¿ç›´è™šçº¿ */}
                    <div className="absolute w-full border-t-2 border-dashed border-green-400 left-0 z-0" style={{top: `${Math.min(100, Math.max(0, goalY))}%`}}></div>
                    <div className="absolute right-0 text-[10px] text-white bg-green-400 px-1 rounded -mt-2.5 z-10" style={{top: `${Math.min(100, Math.max(0, goalY))}%`}}>Target</div>
                    
                    <svg className="w-full h-full overflow-visible relative z-10" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor="#6366f1" stopOpacity="0.2"/>
                                <stop offset="100%" stopColor="#6366f1" stopOpacity="0"/>
                            </linearGradient>
                        </defs>
                        {points.length > 1 && <path d={areaPath} fill="url(#chartGradient)" vectorEffect="non-scaling-stroke" />}
                        {points.length > 1 && <polyline fill="none" stroke="#6366f1" strokeWidth="2.5" points={linePath} strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke" />}
                        {points.map((p, i) => (
                             <g key={i}>
                                <circle cx={`${p.x}`} cy={`${p.y}`} r="3" className="fill-white stroke-indigo-500 stroke-2" vectorEffect="non-scaling-stroke" />
                             </g>
                        ))}
                    </svg>
                </div>
              </div>

              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h2 className="font-bold text-slate-800 mb-6 flex items-center gap-2"><Calendar className="w-5 h-5 text-orange-500" /> ç»¼åˆè¡¨ç° (14å¤©)</h2>
                <div className="flex justify-between items-end gap-1 h-32">
                  {historyData.map((day, i) => {
                    const score = calculateScore(day);
                    let color = "bg-slate-100";
                    if (score >= 80) color = "bg-green-500"; else if (score >= 50) color = "bg-indigo-400"; else if (score > 0) color = "bg-orange-300";
                    return (
                        <div key={i} className="flex-1 flex flex-col items-center justify-end gap-1 h-full">
                            <div className="w-full h-full bg-slate-50 rounded-sm relative flex items-end overflow-hidden">
                                <div className={`w-full transition-all duration-1000 ease-out ${color}`} style={{height: `${score}%`}}></div>
                            </div>
                        </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        };

        // --- Logger Tab (One-Click AI & Dynamic Chef) ---
        const LoggerTab = ({ 
          selectedDate, setSelectedDate, log, saveLog, userProfile, logs,
          foodInput, setFoodInput, handleDayEndAnalysis, loading
        }) => {
          const isToday = formatDate(selectedDate) === formatDate(new Date());
          
          // Bug Fix: é¥®é£Ÿè¾“å…¥æ¡†çŠ¶æ€éšæ—¥æœŸåˆ‡æ¢é‡ç½®
          useEffect(() => {
              setFoodInput(""); // åˆ‡æ¢æ—¥æœŸæ—¶æ¸…ç©º
          }, [selectedDate]);

          // --- åŠ¨æ€ä¸»å¨æ¨èé€»è¾‘ ---
          // ä¼˜å…ˆè¯»å– logs[date].generatedDiet (AIç”Ÿæˆçš„)ï¼Œå¦åˆ™ç”¨é»˜è®¤åº“
          const activeDiet = log.generatedDiet || DEFAULT_MEALS;
          const isDietGenerated = !!log.generatedDiet;

          // åŠ¨ä½œæ›¿æ¢é€»è¾‘
          const activePlan = log.generatedPlan || BASE_PLAN_LIBRARY[selectedDate.getDay()];
          const isPlanGenerated = !!log.generatedPlan;

          const toggleExercise = (index) => {
            const currentSwaps = log.swaps || {}; 
            const exercise = activePlan.exercises[index]; 
            // ç®€å•é€»è¾‘ï¼šå¦‚æœæœ‰æ›¿ä»£åº“åˆ™åˆ‡æ¢ï¼ˆè¿™é‡Œä¸ºæ¼”ç¤ºç®€åŒ–ï¼Œå®é™…å¯æ‰©å±•ï¼‰
            // å‡è®¾ activePlan.exercises[index].alternatives å­˜åœ¨
            // è¿™é‡Œä¸ºäº†ç¨³å¥ï¼Œå¦‚æœæ˜¯ AI ç”Ÿæˆçš„è®¡åˆ’å¯èƒ½æ²¡æœ‰ alternatives å­—æ®µï¼Œåˆ™å¿½ç•¥
            if (!activePlan.exercises[index].alternatives) return;
            // ... (åŒä¹‹å‰çš„é€»è¾‘)
          };

          return (
            <div className="space-y-5 animate-fade-in pb-24 p-4 bg-[#f8f9fa] h-full overflow-y-auto">
              {/* æ—¥æœŸå¯¼èˆª */}
              <div className="flex items-center justify-between bg-white/80 p-3 rounded-2xl shadow-sm sticky top-0 z-20 border border-white/50 backdrop-blur-md">
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() - 1); setSelectedDate(d); }} className="p-2 text-slate-600"><ChevronLeft className="w-5 h-5" /></button>
                <div className="text-center font-bold text-slate-800">
                    {selectedDate.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}
                    <div className="text-[10px] text-indigo-500 font-bold uppercase mt-0.5 tracking-wider">{isPlanGenerated ? "AI å®šåˆ¶æ—¥" : activePlan.title}</div>
                </div>
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() + 1); setSelectedDate(d); }} className="p-2 text-slate-600"><ChevronRight className="w-5 h-5" /></button>
              </div>

              {/* è®­ç»ƒå¡ç‰‡ */}
              <div className={`bg-white p-6 rounded-3xl shadow-sm border-l-4 transition-all ${log.workoutCompleted ? 'border-green-500' : 'border-indigo-500'}`}>
                <div className="flex justify-between items-center mb-5">
                  <h3 className="font-bold text-slate-800 flex items-center gap-2"><Dumbbell className="w-5 h-5 text-indigo-500" /> {isPlanGenerated ? "AI è®¡åˆ’" : "ä»Šæ—¥è®­ç»ƒ"}</h3>
                  <button onClick={() => saveLog(formatDate(selectedDate), { workoutCompleted: !log.workoutCompleted })} className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${log.workoutCompleted ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-400'}`}>
                    {log.workoutCompleted ? 'å·²å®Œæˆ' : 'æ‰“å¡'}
                  </button>
                </div>
                <div className="space-y-4">
                  {activePlan.exercises.map((ex, i) => (
                      <div key={i} className="flex justify-between items-start border-b border-slate-50 pb-3 last:border-0">
                        <div className="font-bold text-sm text-slate-700">{ex.name}</div>
                        <div className="text-xs text-slate-400 font-mono mt-1">{ex.sets}</div>
                      </div>
                  ))}
                </div>
              </div>

              {/* ä¸»å¨æ¨è (å›å½’ç‰ˆ) */}
              <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-5 rounded-3xl shadow-sm border border-orange-100">
                  <div className="flex items-center gap-2 mb-3 font-bold text-orange-800">
                      <ChefHat className="w-5 h-5"/> {isDietGenerated ? "AI ä¸“å±é£Ÿè°±" : "ä¸»å¨æ¨è"}
                  </div>
                  <div className="space-y-3">
                      <div className="bg-white/60 p-3 rounded-xl">
                          <div className="text-[10px] text-orange-400 font-bold uppercase mb-1">æ—©é¤</div>
                          <div className="text-sm font-medium text-slate-700">{activeDiet.breakfast.main}</div>
                      </div>
                      <div className="bg-white/60 p-3 rounded-xl">
                          <div className="text-[10px] text-orange-400 font-bold uppercase mb-1">åˆé¤</div>
                          <div className="text-sm font-medium text-slate-700">{activeDiet.lunch.main}</div>
                      </div>
                      <div className="bg-white/60 p-3 rounded-xl">
                          <div className="text-[10px] text-orange-400 font-bold uppercase mb-1">æ™šé¤</div>
                          <div className="text-sm font-medium text-slate-700">{activeDiet.dinner.main}</div>
                      </div>
                      <div className="bg-indigo-50/80 p-3 rounded-xl border border-indigo-100">
                          <div className="text-[10px] text-indigo-500 font-bold uppercase mb-1">åŠ é¤</div>
                          <div className="text-sm font-medium text-indigo-900">{activeDiet.snack.main}</div>
                      </div>
                  </div>
              </div>

              {/* é¥®é£Ÿè®°å½• & AI ç»“ç®— (åˆå¹¶æŒ‰é’®) */}
              <div className="bg-white p-6 rounded-3xl shadow-sm">
                <div className="flex items-center gap-2 mb-5 font-bold text-slate-800"><Utensils className="w-5 h-5 text-indigo-500" /> å®é™…æ‘„å…¥</div>
                <div className="bg-slate-50 p-1 rounded-2xl mb-6 border border-slate-100 relative">
                  <textarea value={foodInput} onChange={e => setFoodInput(e.target.value)} placeholder="å‘Šè¯‰ AI ä½ ä»Šå¤©åƒäº†ä»€ä¹ˆ..." className="w-full bg-transparent p-4 text-sm rounded-xl outline-none h-24 resize-none placeholder-slate-400 text-slate-700" />
                </div>
                
                {/* ä»…åœ¨ä»Šå¤©æ˜¾ç¤ºç»“ç®—æŒ‰é’®ï¼Œé˜²æ­¢ç¯¡æ”¹å†å²æˆ–é¢„æµ‹æœªæ¥ */}
                {isToday && (
                    <button 
                        onClick={() => handleDayEndAnalysis(foodInput)} 
                        disabled={loading} 
                        className="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl text-sm font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-200 hover:scale-[1.02] transition-transform active:scale-95"
                    >
                        {loading ? <Loader2 className="w-5 h-5 animate-spin"/> : <Sparkles className="w-5 h-5"/>} 
                        {loading ? "AI æ­£åœ¨åˆ†æå…¨å¤©æ•°æ®..." : "ç»“æŸä»Šæ—¥æ‰“å¡ & AI å…¨é‡åˆ†æ"}
                    </button>
                )}
                {/* æ˜¾ç¤ºAIç»™å‡ºçš„ä»Šæ—¥è¯„ä»· */}
                {log.aiAnalysis && <div className="mt-4 bg-slate-100 p-4 rounded-xl text-xs text-slate-600 italic leading-relaxed">ğŸ’¡ æ•™ç»ƒç‚¹è¯„ï¼š{log.aiAnalysis}</div>}
              </div>
            </div>
          );
        };

        // --- Main Logic ---
        function FredFitnessV7() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState({ 
                name: "Fred", startWeight: 80.0, goalWeight: 74.0, startDate: formatDate(new Date()), 
                targetProtein: 160, targetCaloriesTrain: 2200, targetFiber: 30 
            });
            const [logs, setLogs] = useState({});
            const [activeTab, setActiveTab] = useState('log');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [setupMode, setSetupMode] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);
            const [foodInput, setFoodInput] = useState("");
            const [apiKey, setApiKey] = useState(localStorage.getItem('fred_deepseek_key') || DEFAULT_DEEPSEEK_KEY);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u); setLoading(false);
                    if (u) {
                        onSnapshot(doc(db, "users", u.uid), (doc) => {
                            if (doc.exists()) {
                                const d = doc.data();
                                if (d.profile) setUserProfile(d.profile);
                                if (d.logs) setLogs(d.logs);
                                setSetupMode(false);
                            } else setSetupMode(true);
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            const saveToCloud = (p, l) => { if(user) setDoc(doc(db, "users", user.uid), {profile: p||userProfile, logs: l||logs}, {merge:true}); };
            const saveProfile = (p) => { setUserProfile(p); saveToCloud(p, null); setSetupMode(false); setShowSettings(false); };
            const saveLog = (d, data) => { const nl = {...logs, [d]: {...logs[d], ...data}}; setLogs(nl); saveToCloud(null, nl); };

            const handleReset = async () => {
                if(!confirm("âš ï¸ ç¡®å®šé‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿä¸å¯æ¢å¤ï¼")) return;
                const newP = {...userProfile, startDate: formatDate(new Date())};
                setUserProfile(newP); setLogs({}); setSetupMode(true); setShowSettings(false);
                if(user) await setDoc(doc(db, "users", user.uid), {profile: newP, logs: {}});
            };

            const callDeepSeek = async (prompt) => {
                setAiLoading(true);
                try {
                    const res = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST", headers: {"Content-Type":"application/json", "Authorization":`Bearer ${apiKey}`},
                        body: JSON.stringify({model:"deepseek-chat", messages:[{role:"system",content:"You are Fred's fitness coach. Respond in JSON only."}, {role:"user",content:prompt}]})
                    });
                    const data = await res.json();
                    return data.choices[0].message.content;
                } catch(e) { alert("AI Error"); return null; } finally { setAiLoading(false); }
            };

            // V7.0 æ ¸å¿ƒï¼šä¸€é”®å…¨é‡åˆ†æ
            const handleDayEndAnalysis = async (foodText) => {
                const today = formatDate(selectedDate);
                const tmr = new Date(selectedDate); tmr.setDate(tmr.getDate()+1);
                const tmrStr = formatDate(tmr);

                // 1. æ„å»º Prompt
                const prompt = `
                Current Date: ${today}. Food eaten: ${foodText}.
                My Stats: Weight ${userProfile.startWeight}kg -> Goal ${userProfile.goalWeight}kg.
                Task:
                1. Analyze nutrition of food eaten (calories, protein, fiber).
                2. Give short feedback for today.
                3. Create a custom workout & diet plan for TOMORROW (${tmrStr}) based on today's performance.
                
                Return JSON format ONLY:
                {
                    "nutrition": {"calories": int, "protein": int, "fiber": int},
                    "feedback": "string",
                    "tomorrow": {
                        "workout": {"title": "string", "exercises": [{"name": "string", "sets": "string"}]},
                        "diet": {
                            "breakfast": {"main": "string", "alt": "string"},
                            "lunch": {"main": "string", "alt": "string"},
                            "dinner": {"main": "string", "alt": "string"},
                            "snack": {"main": "string", "alt": "string"}
                        }
                    }
                }`;

                const res = await callDeepSeek(prompt);
                if (res) {
                    try {
                        const json = JSON.parse(res.replace(/```json|```/g, '').trim());
                        
                        // 1. æ›´æ–°ä»Šæ—¥ï¼šå†™å…¥è¥å…»æ•°æ® + è¯„ä»·
                        const curLog = logs[today] || {};
                        saveLog(today, {
                            calories: (curLog.calories||0) + json.nutrition.calories,
                            protein: (curLog.protein||0) + json.nutrition.protein,
                            fiber: (curLog.fiber||0) + json.nutrition.fiber,
                            aiAnalysis: json.feedback,
                            workoutCompleted: true // è‡ªåŠ¨æ ‡è®°å®Œæˆ
                        });

                        // 2. æ›´æ–°æ˜æ—¥ï¼šå†™å…¥è®¡åˆ’
                        saveLog(tmrStr, {
                            generatedPlan: json.tomorrow.workout,
                            generatedDiet: json.tomorrow.diet
                        });
                        
                        alert("âœ… ä»Šæ—¥ç»“ç®—å®Œæˆï¼æ˜æ—¥è®¡åˆ’å·²è‡ªåŠ¨ç”Ÿæˆã€‚");
                        setFoodInput(""); // æ¸…ç©ºè¾“å…¥æ¡†
                    } catch(e) { console.error(e); alert("AI è§£æå¤±è´¥"); }
                }
            };

            if (loading) return <div className="h-full flex items-center justify-center text-slate-500 animate-pulse">è¿æ¥äº‘ç«¯...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="h-full flex flex-col bg-[#f8f9fa] font-sans text-slate-900 overflow-hidden relative">
                    <header className="bg-white/80 p-4 shadow-sm z-30 flex justify-between items-center backdrop-blur-md absolute top-0 w-full border-b border-slate-100">
                        <div className="flex items-center gap-2">{user.photoURL && <img src={user.photoURL} className="w-8 h-8 rounded-full border border-indigo-100"/>}<div><h1 className="font-bold text-lg text-slate-800 tracking-tight">Fred<span className="text-indigo-600">.AI</span></h1></div></div>
                        <div className="flex gap-4"><button onClick={() => signOut(auth)}><LogOut className="w-5 h-5 text-slate-400"/></button><button onClick={() => setShowSettings(!showSettings)}><Settings className="w-5 h-5 text-slate-600 hover:text-indigo-600"/></button></div>
                    </header>
                    <main className="flex-1 overflow-y-auto scrollbar-hide pt-16">
                        {setupMode ? <SettingsTab apiKey={apiKey} setApiKey={setApiKey} userProfile={userProfile} saveProfile={saveProfile} setSetupMode={setSetupMode} handleReset={handleReset} /> : 
                        showSettings ? <SettingsTab apiKey={apiKey} setApiKey={setApiKey} userProfile={userProfile} saveProfile={saveProfile} setSetupMode={setSetupMode} handleReset={handleReset} /> :
                        activeTab === 'log' ? <LoggerTab selectedDate={selectedDate} setSelectedDate={setSelectedDate} log={logs[formatDate(selectedDate)]||{}} saveLog={saveLog} userProfile={userProfile} logs={logs} foodInput={foodInput} setFoodInput={setFoodInput} handleDayEndAnalysis={handleDayEndAnalysis} loading={aiLoading} /> : <HistoryTab userProfile={userProfile} logs={logs} />}
                    </main>
                    <nav className="bg-white border-t border-slate-100 flex justify-around py-3 pb-6 z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] absolute bottom-0 w-full rounded-t-3xl">
                        <button onClick={() => { setActiveTab('history'); setShowSettings(false); }} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'history' ? 'text-indigo-600 scale-105' : 'text-slate-400'}`}><History className="w-6 h-6" /><span className="text-[10px] font-bold mt-1">è¶‹åŠ¿</span></button>
                        <button onClick={() => { setActiveTab('log'); setShowSettings(false); }} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'log' ? 'text-indigo-600 scale-105' : 'text-slate-400'}`}><Activity className="w-6 h-6" /><span className="text-[10px] font-bold mt-1">æ‰“å¡</span></button>
                    </nav>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<FredFitnessV7 />);

    </script>
</body>
</html>