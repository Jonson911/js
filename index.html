<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fred 60天腹肌特训中控台 (V4.1)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 h-screen w-screen overflow-hidden flex justify-center items-center">

    <div id="root" class="w-full h-full max-w-md bg-white shadow-2xl overflow-hidden relative sm:rounded-xl sm:h-[90vh] sm:border sm:border-slate-200"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Activity, Utensils, Scale, Calendar, Trophy, TrendingDown, 
          Dumbbell, Droplets, BrainCircuit, ChevronRight, AlertTriangle, 
          RefreshCw, MessageSquare, Settings, Send, Loader2, Save, 
          ChevronLeft, History, CheckCircle2, XCircle, ArrowLeftRight
        } from 'lucide-react';

        const DEFAULT_API_KEY = "sk-72fba3190e5c4147bdd1b27fcab574dc";
        
        // --- 1. 预设替换库 (Hardcoded Alternatives) ---
        // 结构：exercises 数组中，每个对象增加 alternatives 数组
        const BASE_PLAN = {
          1: { title: "胸部 & 三头肌 (推力)", type: "Strength", warmup: "10分钟 椭圆机", exercises: [
            { name: "动态伸展", sets: "5分钟", note: "肩袖预热", alternatives: [{name: "弹力带绕肩", sets: "5分钟", note: "居家替代"}] },
            { name: "平板杠铃卧推", sets: "4组 x 10次", note: "核心动作", alternatives: [{name: "大重量俯卧撑", sets: "4组 x 力竭", note: "居家替代"}, {name: "史密斯机卧推", sets: "4组 x 12次", note: "固定器械"}] },
            { name: "上斜哑铃卧推", sets: "4组 x 12次", note: "上胸", alternatives: [{name: "下斜俯卧撑", sets: "4组 x 15次", note: "脚垫高"}, {name: "器械上斜推胸", sets: "4组 x 12次", note: "固定器械"}] },
            { name: "绳索下压", sets: "4组 x 15次", note: "三头肌", alternatives: [{name: "哑铃颈后臂屈伸", sets: "4组 x 15次", note: "哑铃替代"}, {name: "窄距俯卧撑", sets: "4组 x 力竭", note: "徒手替代"}] },
            { name: "悬垂举腿", sets: "4组 x 力竭", note: "腹肌", alternatives: [{name: "仰卧抬腿", sets: "4组 x 20次", note: "平地替代"}] }
          ]},
          2: { title: "背部 & 二头肌 (拉力)", type: "Strength", warmup: "10分钟 划船机", exercises: [
            { name: "肩部激活", sets: "5分钟", note: "弹力带", alternatives: [{name: "徒手招财猫", sets: "5分钟", note: "无器械"}] },
            { name: "高位下拉", sets: "4组 x 12次", note: "背阔肌", alternatives: [{name: "引体向上 (助力)", sets: "4组 x 8次", note: "进阶"}, {name: "弹力带高位下拉", sets: "4组 x 20次", note: "居家"}] },
            { name: "坐姿划船", sets: "4组 x 12次", note: "背部厚度", alternatives: [{name: "俯身哑铃划船", sets: "4组 x 12次", note: "哑铃替代"}, {name: "澳式引体", sets: "4组 x 力竭", note: "单杠替代"}] },
            { name: "杠铃弯举", sets: "4组 x 12次", note: "二头肌", alternatives: [{name: "哑铃交替弯举", sets: "4组 x 12次", note: "更孤立"}, {name: "弹力带弯举", sets: "4组 x 20次", note: "居家"}] },
            { name: "平板支撑", sets: "4组 x 60秒", note: "核心", alternatives: [{name: "死虫式", sets: "4组 x 20次", note: "护腰替代"}] }
          ]},
          3: { title: "腿部 & 肩部 (强代谢)", type: "HighIntensity", warmup: "10分钟 单车", exercises: [
            { name: "髋关节灵活性", sets: "5分钟", note: "必做", alternatives: [{name: "青蛙趴", sets: "5分钟", note: "拉伸"}] },
            { name: "深蹲/腿举", sets: "5组 x 10次", note: "王牌动作", alternatives: [{name: "高脚杯深蹲", sets: "5组 x 15次", note: "哑铃替代"}, {name: "徒手深蹲跳", sets: "5组 x 20次", note: "无器械爆发力"}] },
            { name: "哑铃推举", sets: "4组 x 12次", note: "三角肌前束", alternatives: [{name: "倒立撑/折刀俯卧撑", sets: "4组 x 10次", note: "自重高难度"}, {name: "弹力带推举", sets: "4组 x 20次", note: "居家"}] },
            { name: "侧平举", sets: "5组 x 15次", note: "中束", alternatives: [{name: "直立划船", sets: "4组 x 12次", note: "复合动作"}] },
            { name: "腿屈伸", sets: "3组 x 15次", note: "线条", alternatives: [{name: "箭步蹲", sets: "3组 x 20次", note: "徒手替代"}] }
          ]},
          4: { title: "有氧燃脂 & 腹肌", type: "Cardio", warmup: "5分钟 慢跑", exercises: [
            { name: "卷腹", sets: "4组 x 20次", note: "上腹", alternatives: [{name: "摸膝卷腹", sets: "4组 x 20次", note: "基础"}] },
            { name: "俄罗斯转体", sets: "4组 x 20次", note: "侧腹", alternatives: [{name: "侧支撑", sets: "4组 x 45秒", note: "静态"}] },
            { name: "反向卷腹", sets: "4组 x 15次", note: "下腹", alternatives: [{name: "登山跑", sets: "4组 x 30秒", note: "心肺结合"}] },
            { name: "真空腹", sets: "5组 x 30秒", note: "腹横肌", alternatives: [{name: "平板支撑", sets: "4组 x 60秒", note: "替代"}] }
          ]},
          5: { title: "深度恢复 (REST)", type: "Rest", warmup: "无", exercises: [
            { name: "泡沫轴放松", sets: "20分钟", note: "全身", alternatives: [{name: "瑜伽拉伸", sets: "20分钟", note: "柔韧性"}] },
            { name: "温水澡", sets: "15分钟", note: "循环", alternatives: [{name: "冥想", sets: "10分钟", note: "精神恢复"}] }
          ]},
          6: { title: "HIIT & 全身循环", type: "HIIT", warmup: "5分钟 动态", exercises: [
            { name: "波比跳", sets: "10个 x 5组", note: "心肺", alternatives: [{name: "简易波比(不俯卧撑)", sets: "10个 x 5组", note: "降阶"}] },
            { name: "壶铃摇摆", sets: "20个 x 4组", note: "后链", alternatives: [{name: "臀桥", sets: "20个 x 4组", note: "徒手替代"}] },
            { name: "战绳", sets: "30秒 x 4组", note: "代谢", alternatives: [{name: "快速开合跳", sets: "45秒 x 4组", note: "徒手替代"}] },
            { name: "核心三合一", sets: "3组", note: "腹肌", alternatives: [{name: "卷腹超级组", sets: "3组", note: "替代"}] }
          ]},
          0: { title: "户外耐力", type: "ActiveRecovery", warmup: "动态拉伸", exercises: [
            { name: "户外骑行/爬山", sets: "60分钟+", note: "Zone 2心率", alternatives: [{name: "室内动感单车", sets: "45分钟", note: "雨天替代"}, {name: "跑步机爬坡", sets: "45分钟", note: "健身房替代"}, {name: "爬楼梯", sets: "30分钟", note: "高强度替代"}] },
            { name: "全身拉伸", sets: "20分钟", note: "静态", alternatives: [{name: "筋膜枪放松", sets: "15分钟", note: "器械辅助"}] }
          ]}
        };

        const formatDate = (date) => date.toISOString().split('T')[0];

        // --- 子组件分离 (修复输入焦点丢失问题) ---

        // 1. 设置组件
        const SettingsTab = ({ apiKey, setApiKey, userProfile, saveProfile, setSetupMode }) => (
          <div className="p-6 space-y-6 animate-fade-in bg-white h-full">
            <h2 className="text-xl font-bold flex items-center gap-2"><Settings className="w-6 h-6" /> 设置</h2>
            <div className="space-y-4">
              <div>
                <label className="text-xs font-bold text-slate-500">API Key</label>
                <input type="password" value={apiKey} onChange={e => { setApiKey(e.target.value); localStorage.setItem('fred_deepseek_key', e.target.value); }} className="w-full border-b border-slate-200 py-2 outline-none font-mono text-sm" />
              </div>
              <div>
                <label className="text-xs font-bold text-slate-500">目标体重</label>
                <input type="number" value={userProfile.goalWeight} onChange={e => { const p = {...userProfile, goalWeight: parseFloat(e.target.value)}; saveProfile(p); }} className="w-full border-b border-slate-200 py-2 outline-none font-mono text-sm" />
              </div>
              <button onClick={() => setSetupMode(true)} className="w-full py-3 bg-slate-100 text-slate-600 rounded-lg text-sm font-bold">重新运行初始化向导</button>
            </div>
          </div>
        );

        // 2. 历史组件
        const HistoryTab = ({ userProfile, logs }) => {
          const historyData = useMemo(() => {
            const start = new Date(userProfile.startDate);
            const end = new Date();
            const days = [];
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
              const dateStr = formatDate(d);
              // 内联 getLog 逻辑以避免依赖
              let log = logs[dateStr];
              if (!log && dateStr < formatDate(new Date())) {
                log = { isVirtual: true, weight: null, calories: 2000, protein: 80, workoutCompleted: false };
              } else if (!log) {
                log = { weight: null, protein: 0, calories: 0, workoutCompleted: false };
              }
              days.push({ date: dateStr, ...log });
            }
            return days;
          }, [logs, userProfile.startDate]);

          const currentWeight = historyData.slice().reverse().find(d => d.weight)?.weight || userProfile.startWeight;
          const progress = (userProfile.startWeight - currentWeight).toFixed(1);

          return (
            <div className="space-y-6 animate-fade-in pb-20 p-4">
              <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><TrendingDown className="w-5 h-5 text-indigo-600" /> 核心指标</h2>
                <div className="grid grid-cols-3 gap-4 text-center">
                  <div className="p-3 bg-slate-50 rounded-xl"><div className="text-xs text-slate-400">初始</div><div className="font-mono font-bold text-slate-700">{userProfile.startWeight}</div></div>
                  <div className="p-3 bg-indigo-50 rounded-xl border border-indigo-100"><div className="text-xs text-indigo-400">当前</div><div className="font-mono font-bold text-indigo-700 text-xl">{currentWeight}</div></div>
                  <div className="p-3 bg-slate-50 rounded-xl"><div className="text-xs text-slate-400">目标</div><div className="font-mono font-bold text-slate-700">{userProfile.goalWeight}</div></div>
                </div>
                <div className="mt-4 bg-gray-100 rounded-full h-2 overflow-hidden">
                  <div className="bg-green-500 h-full transition-all duration-1000" style={{ width: `${Math.min(100, Math.max(0, (progress / (userProfile.startWeight - userProfile.goalWeight)) * 100))}%` }}></div>
                </div>
                <div className="text-center text-xs text-slate-400 mt-1">已完成 {Math.abs(progress)}kg 的减脂目标</div>
              </div>

              <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Calendar className="w-5 h-5 text-orange-500" /> 执行热力图</h2>
                <div className="grid grid-cols-7 gap-1">
                  {['一','二','三','四','五','六','日'].map(d => <div key={d} className="text-center text-xs text-slate-300 font-bold mb-2">{d}</div>)}
                  {historyData.slice(-28).map((day, i) => {
                    let color = "bg-slate-100";
                    if (!day.isVirtual) {
                      if (day.workoutCompleted && day.protein >= 120) color = "bg-green-500";
                      else if (day.workoutCompleted) color = "bg-blue-400";
                      else if (day.calories > 2500) color = "bg-red-400";
                      else color = "bg-slate-200";
                    }
                    return <div key={i} className={`aspect-square rounded-md ${color} relative group`}></div>
                  })}
                </div>
              </div>
            </div>
          );
        };

        // 3. 记录组件 (核心修复点：独立组件，接收 Props)
        const LoggerTab = ({ 
          selectedDate, setSelectedDate, log, saveLog, userProfile, dayPlan, 
          foodInput, setFoodInput, handleFoodAnalysis, loading, generateDailySummary 
        }) => {
          const isToday = formatDate(selectedDate) === formatDate(new Date());

          // 处理运动替换逻辑
          const toggleExercise = (index) => {
            const currentSwaps = log.swaps || {};
            const exercise = dayPlan.exercises[index];
            if (!exercise.alternatives || exercise.alternatives.length === 0) return;

            const currentAltIndex = currentSwaps[index]; // undefined = main, 0 = alt 1, 1 = alt 2...
            
            let nextAltIndex;
            if (currentAltIndex === undefined) {
                nextAltIndex = 0; // 切到第一个备选
            } else if (currentAltIndex < exercise.alternatives.length - 1) {
                nextAltIndex = currentAltIndex + 1; // 切到下一个备选
            } else {
                nextAltIndex = undefined; // 回到主项
            }

            const newSwaps = { ...currentSwaps };
            if (nextAltIndex === undefined) {
                delete newSwaps[index];
            } else {
                newSwaps[index] = nextAltIndex;
            }
            
            saveLog(formatDate(selectedDate), { swaps: newSwaps, isVirtual: false });
          };

          return (
            <div className="space-y-4 animate-fade-in pb-20 p-4">
              {/* 日期导航 */}
              <div className="flex items-center justify-between bg-white p-3 rounded-xl shadow-sm sticky top-0 z-20 border border-slate-100">
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() - 1); setSelectedDate(d); }} className="p-2 bg-slate-50 rounded-full text-slate-600"><ChevronLeft className="w-5 h-5" /></button>
                <div className="text-center">
                  <div className="font-bold text-slate-800 flex items-center justify-center gap-2">
                    {isToday && <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>}
                    {selectedDate.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}
                  </div>
                  <div className="text-[10px] text-indigo-500 font-bold uppercase mt-0.5">{dayPlan.title}</div>
                </div>
                <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() + 1); setSelectedDate(d); }} className="p-2 bg-slate-50 rounded-full text-slate-600"><ChevronRight className="w-5 h-5" /></button>
              </div>

              {log.isVirtual && <div className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg flex gap-2 text-xs text-yellow-800"><AlertTriangle className="w-4 h-4 shrink-0" /><span>这天没有手动记录，系统已自动按“维持期”数据填充统计。如有需要请手动修改。</span></div>}

              {/* 训练列表 (带替换功能) */}
              <div className={`bg-white p-5 rounded-2xl shadow-sm border-l-4 ${log.workoutCompleted ? 'border-green-500' : 'border-indigo-500'}`}>
                <div className="flex justify-between items-center mb-3">
                  <h3 className="font-bold text-slate-900">今日训练</h3>
                  <button onClick={() => saveLog(formatDate(selectedDate), { workoutCompleted: !log.workoutCompleted, isVirtual: false })} className={`px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1 ${log.workoutCompleted ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-400'}`}>
                    {log.workoutCompleted ? <CheckCircle2 className="w-3 h-3" /> : <div className="w-3 h-3 rounded-full border border-slate-400"></div>}
                    {log.workoutCompleted ? '已完成' : '点击打卡'}
                  </button>
                </div>
                <div className="space-y-3">
                  {dayPlan.exercises.map((ex, i) => {
                    // 计算当前显示的动作
                    const swapIndex = log.swaps ? log.swaps[i] : undefined;
                    const isSwapped = swapIndex !== undefined;
                    const displayEx = isSwapped ? ex.alternatives[swapIndex] : ex;
                    const hasAlts = ex.alternatives && ex.alternatives.length > 0;

                    return (
                      <div key={i} className="flex justify-between items-start border-b border-slate-50 pb-2 last:border-0">
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                             <span className={`text-sm font-medium ${isSwapped ? 'text-indigo-600' : 'text-slate-700'}`}>{displayEx.name}</span>
                             {isSwapped && <span className="text-[10px] bg-indigo-50 text-indigo-500 px-1 rounded">替代</span>}
                          </div>
                          <div className="text-xs text-slate-400 font-mono mt-0.5">{displayEx.sets} · {displayEx.note}</div>
                        </div>
                        
                        {/* 替换按钮 */}
                        {hasAlts && (
                            <button 
                                onClick={() => toggleExercise(i)}
                                className="p-2 text-slate-300 hover:text-indigo-500 transition-colors"
                                title="切换替代动作"
                            >
                                <ArrowLeftRight className="w-4 h-4" />
                            </button>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* 摄入与身体 (修复输入焦点问题) */}
              <div className="bg-white p-5 rounded-2xl shadow-sm">
                <div className="flex items-center gap-2 mb-4 font-bold text-slate-800"><Utensils className="w-5 h-5 text-orange-500" /> 摄入与身体</div>
                
                <div className="bg-indigo-50 p-3 rounded-xl mb-6 border border-indigo-100">
                  <textarea value={foodInput} onChange={e => setFoodInput(e.target.value)} placeholder="AI记录：午饭吃了一碗牛肉面，加个蛋..." className="w-full bg-white p-2 text-sm rounded-lg outline-none border border-indigo-200 focus:border-indigo-500 h-16 resize-none mb-2" />
                  <button onClick={handleFoodAnalysis} disabled={loading} className="w-full bg-indigo-600 text-white py-1.5 rounded-lg text-xs font-bold flex justify-center items-center gap-1">
                    {loading ? <Loader2 className="w-3 h-3 animate-spin" /> : <BrainCircuit className="w-3 h-3" />} 智能识别并添加
                  </button>
                </div>

                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div className="bg-slate-50 p-3 rounded-xl">
                    <div className="text-xs text-slate-400 mb-1">蛋白质 (g)</div>
                    <div className="flex justify-between items-end">
                      <input 
                        type="number" min="0" 
                        value={log.protein === undefined || log.protein === null ? '' : log.protein} 
                        onChange={e => saveLog(formatDate(selectedDate), { protein: parseFloat(e.target.value) || 0, isVirtual: false })} 
                        className="w-16 bg-transparent font-mono font-bold text-lg outline-none text-slate-800" placeholder="0" 
                      />
                      <span className="text-[10px] text-slate-400">/ {userProfile.targetProtein}</span>
                    </div>
                    <div className="w-full bg-slate-200 h-1 mt-1 rounded-full overflow-hidden"><div className="bg-indigo-500 h-full" style={{ width: `${Math.min(100, (log.protein/userProfile.targetProtein)*100)}%` }}></div></div>
                  </div>
                  <div className="bg-slate-50 p-3 rounded-xl">
                    <div className="text-xs text-slate-400 mb-1">热量 (kcal)</div>
                    <div className="flex justify-between items-end">
                      <input 
                        type="number" min="0" 
                        value={log.calories === undefined || log.calories === null ? '' : log.calories} 
                        onChange={e => saveLog(formatDate(selectedDate), { calories: parseFloat(e.target.value) || 0, isVirtual: false })} 
                        className="w-16 bg-transparent font-mono font-bold text-lg outline-none text-slate-800" placeholder="0" 
                      />
                      <span className="text-[10px] text-slate-400">/ {dayPlan.type === 'Rest' ? userProfile.targetCaloriesRest : userProfile.targetCaloriesTrain}</span>
                    </div>
                    <div className="w-full bg-slate-200 h-1 mt-1 rounded-full overflow-hidden"><div className={`h-full ${log.calories > 2500 ? 'bg-red-500' : 'bg-green-500'}`} style={{ width: `${Math.min(100, (log.calories/2200)*100)}%` }}></div></div>
                  </div>
                </div>

                <div className="border-t border-slate-100 pt-4">
                  <div className="flex justify-between items-center">
                    <span className="text-sm font-bold text-slate-700">今日晨重</span>
                    <div className="flex items-center gap-2">
                      <input 
                        type="number" min="0" step="0.1" 
                        value={log.weight === undefined || log.weight === null ? '' : log.weight} 
                        onChange={e => saveLog(formatDate(selectedDate), { weight: parseFloat(e.target.value) || 0, isVirtual: false })} 
                        className="w-20 bg-slate-100 p-1.5 rounded text-center font-bold text-slate-800 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="80.0" 
                      />
                      <span className="text-xs text-slate-500">kg</span>
                    </div>
                  </div>
                </div>
              </div>

              {log.aiAnalysis ? <div className="bg-slate-800 p-4 rounded-2xl shadow-sm text-slate-300 text-sm italic border-l-4 border-indigo-500">"{log.aiAnalysis}"</div> : <button onClick={generateDailySummary} className="w-full py-3 border border-dashed border-slate-300 text-slate-400 rounded-xl text-xs hover:bg-slate-50 transition-colors">点击生成今日 AI 教练总结</button>}
            </div>
          );
        };

        // --- 主应用组件 ---
        function FredFitnessTrackerV4() {
          const [setupMode, setSetupMode] = useState(false); 
          const [userProfile, setUserProfile] = useState({ name: "Fred", height: 182, startWeight: 80.0, goalWeight: 74.0, startDate: "2025-12-14", age: 41, targetProtein: 160, targetCaloriesRest: 1800, targetCaloriesTrain: 2300 });
          const [activeTab, setActiveTab] = useState('log'); 
          const [logs, setLogs] = useState({});
          const [selectedDate, setSelectedDate] = useState(new Date()); 
          const [apiKey, setApiKey] = useState(DEFAULT_API_KEY);
          const [loading, setLoading] = useState(false);
          const [foodInput, setFoodInput] = useState("");
          const [showSettings, setShowSettings] = useState(false);

          useEffect(() => {
            const savedProfile = localStorage.getItem('fred_profile_v4');
            if (savedProfile) setUserProfile(JSON.parse(savedProfile)); else setSetupMode(true);
            const savedLogs = localStorage.getItem('fred_logs_v4');
            if (savedLogs) setLogs(JSON.parse(savedLogs));
            const savedKey = localStorage.getItem('fred_deepseek_key');
            if (savedKey) setApiKey(savedKey);
            setSelectedDate(new Date());
          }, []);

          const saveProfile = (newProfile) => {
            setUserProfile(newProfile);
            localStorage.setItem('fred_profile_v4', JSON.stringify(newProfile));
            setSetupMode(false);
          };

          const saveLog = (dateStr, data) => {
            const newLogs = { ...logs, [dateStr]: { ...logs[dateStr], ...data, date: dateStr } };
            setLogs(newLogs);
            localStorage.setItem('fred_logs_v4', JSON.stringify(newLogs));
          };

          const getLog = (dateStr) => {
            if (logs[dateStr]) return logs[dateStr];
            const todayStr = formatDate(new Date());
            if (dateStr < todayStr) return { isVirtual: true, weight: null, calories: 2000, protein: 80, workoutCompleted: false, foodLog: [], swaps: {} };
            return { weight: null, protein: 0, calories: 0, workoutCompleted: false, foodLog: [], swaps: {} };
          };

          const callDeepSeek = async (systemPrompt, userPrompt) => {
            if (!apiKey) { alert("请在设置中检查 API Key"); return null; }
            try {
              setLoading(true);
              const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], temperature: 0.7 })
              });
              const data = await response.json();
              setLoading(false);
              return data.choices[0].message.content;
            } catch (error) { setLoading(false); alert("AI 连接失败: " + error.message); return null; }
          };

          const handleFoodAnalysis = async () => {
            if (!foodInput.trim()) return;
            const prompt = `分析食物：${foodInput}。返回JSON格式：{"calories": number, "protein": number, "analysis": "string"}`;
            const res = await callDeepSeek("营养师，只回JSON", prompt);
            if (res) {
              try {
                const cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(cleanJson);
                const current = getLog(formatDate(selectedDate));
                saveLog(formatDate(selectedDate), {
                  calories: (current.calories || 0) + data.calories,
                  protein: (current.protein || 0) + data.protein,
                  foodLog: [...(current.foodLog || []), { time: '刚刚', text: foodInput, cal: data.calories, pro: data.protein }]
                });
                setFoodInput("");
              } catch (e) { alert("解析失败"); }
            }
          };

          const generateDailySummary = async () => {
            const current = getLog(formatDate(selectedDate));
            const prompt = `日期:${formatDate(selectedDate)}, 体重:${current.weight || '未测'}, 热量:${current.calories}, 蛋白:${current.protein}, 训练:${current.workoutCompleted?'是':'否'}。给Fred一段简短犀利的点评。`;
            const res = await callDeepSeek("严格健身教练", prompt);
            if (res) saveLog(formatDate(selectedDate), { aiAnalysis: res });
          };

          // 初始化向导
          if (setupMode) {
            return React.createElement("div", { className: "h-full bg-slate-900 text-white p-6 flex flex-col justify-center animate-fade-in" },
              React.createElement("div", { className: "mb-8 text-center" },
                React.createElement(Activity, { className: "w-16 h-16 text-indigo-500 mx-auto mb-4" }),
                React.createElement("h1", { className: "text-2xl font-bold mb-2" }, "欢迎, Fred"),
                React.createElement("p", { className: "text-slate-400" }, "让我们校准你的初始数据，以获得最精准的AI分析。")
              ),
              React.createElement("div", { className: "space-y-4 bg-slate-800 p-6 rounded-2xl" },
                React.createElement("div", null, React.createElement("label", { className: "block text-xs text-slate-400 mb-1" }, "初始体重 (kg)"), React.createElement("input", { type: "number", value: userProfile.startWeight, onChange: e => setUserProfile({...userProfile, startWeight: parseFloat(e.target.value) || 0}), className: "w-full bg-slate-700 p-3 rounded text-lg font-bold outline-none border border-transparent focus:border-indigo-500" })),
                React.createElement("div", null, React.createElement("label", { className: "block text-xs text-slate-400 mb-1" }, "目标体重 (kg)"), React.createElement("input", { type: "number", value: userProfile.goalWeight, onChange: e => setUserProfile({...userProfile, goalWeight: parseFloat(e.target.value) || 0}), className: "w-full bg-slate-700 p-3 rounded text-lg font-bold outline-none border border-transparent focus:border-indigo-500" })),
                React.createElement("div", null, React.createElement("label", { className: "block text-xs text-slate-400 mb-1" }, "计划开始日期"), React.createElement("input", { type: "date", value: userProfile.startDate, onChange: e => setUserProfile({...userProfile, startDate: e.target.value}), className: "w-full bg-slate-700 p-3 rounded text-lg font-bold outline-none border border-transparent focus:border-indigo-500" }))
              ),
              React.createElement("button", { onClick: () => saveProfile(userProfile), className: "mt-8 bg-indigo-600 w-full py-4 rounded-xl font-bold text-lg hover:bg-indigo-500 transition-colors flex items-center justify-center gap-2" }, "开启计划 ", React.createElement(ChevronRight, null))
            );
          }

          const currentLog = getLog(formatDate(selectedDate));
          const dayPlan = BASE_PLAN[selectedDate.getDay()];

          return React.createElement("div", { className: "h-full flex flex-col bg-slate-50 font-sans text-slate-900 overflow-hidden relative" },
            React.createElement("header", { className: "bg-white p-4 shadow-sm z-30 flex justify-between items-center" },
              React.createElement("h1", { className: "font-black text-xl italic text-slate-800 tracking-tighter" }, "FRED", React.createElement("span", { className: "text-indigo-600" }, ".PRO")),
              React.createElement("button", { onClick: () => setShowSettings(!showSettings), className: "text-slate-400 hover:text-indigo-600" }, React.createElement(Settings, { className: "w-5 h-5" }))
            ),
            React.createElement("main", { className: "flex-1 overflow-y-auto scrollbar-hide" },
              showSettings ? React.createElement(SettingsTab, { apiKey, setApiKey, userProfile, saveProfile, setSetupMode }) : 
              (activeTab === 'log' 
                ? React.createElement(LoggerTab, { 
                    selectedDate, setSelectedDate, log: currentLog, saveLog, userProfile, dayPlan, 
                    foodInput, setFoodInput, handleFoodAnalysis, loading, generateDailySummary 
                  }) 
                : React.createElement(HistoryTab, { userProfile, logs }))
            ),
            React.createElement("nav", { className: "bg-white border-t border-slate-100 flex justify-around py-2 pb-5 z-30 shadow-[0_-5px_10px_rgba(0,0,0,0.02)]" },
              React.createElement("button", { onClick: () => { setActiveTab('history'); setShowSettings(false); }, className: `flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'history' && !showSettings ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'}` }, React.createElement(History, { className: "w-6 h-6" }), React.createElement("span", { className: "text-[10px] font-bold mt-1" }, "历史/趋势")),
              React.createElement("button", { onClick: () => { setActiveTab('log'); setShowSettings(false); setSelectedDate(new Date()); }, className: `flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'log' && !showSettings ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'}` }, React.createElement(Activity, { className: "w-6 h-6" }), React.createElement("span", { className: "text-[10px] font-bold mt-1" }, "今日打卡"))
            )
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(FredFitnessTrackerV4));

    </script>
</body>
</html>